<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم ليلى: مساعد المتجر الذكي</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font and general body styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        /* Custom scrollbar for textareas */
        textarea::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        textarea::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto bg-white shadow-lg rounded-xl p-6 md:p-10">
        <!-- Header Section -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-2">لوحة تحكم ليلى - متجر الكتب</h1>
            <p class="text-lg text-gray-600 mb-4">أداة شاملة ومستقلة لتدريب وإدارة مساعدك الذكي "ليلى".</p>
            <div class="bg-blue-100 text-blue-800 p-3 rounded-lg text-sm mb-4">
                <span class="font-semibold">معرف المستخدم الذي تتصل به (للتخزين):</span>
                <span id="userIdDisplay" class="break-all font-mono text-blue-900">جاري التحميل...</span>
            </div>
            <!-- Message Display Area -->
            <div id="messageDisplay" class="p-3 rounded-lg text-center text-sm font-medium hidden"></div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Column: Intent, Product, Notes, and Notifications Forms -->
            <div class="space-y-8">
                <!-- Train Layla: Add New Intent Section -->
                <section class="bg-gray-50 p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">تدريب ليلى: إضافة نية جديدة</h2>
                    <div class="mb-4">
                        <label for="intentName" class="block text-sm font-medium text-gray-700 mb-1">اسم النية:</label>
                        <input type="text" id="intentName" placeholder="مثال: ساعات العمل" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="trainingPhrases" class="block text-sm font-medium text-gray-700 mb-1">العبارات التدريبية (افصل بفاصلة أو سطر جديد):</label>
                        <textarea id="trainingPhrases" rows="4" placeholder="مثال: متى تفتحون؟, ما هي ساعات عملكم؟" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div class="mb-6">
                        <label for="intentOutput" class="block text-sm font-medium text-gray-700 mb-1">المخرج (الإجابة):</label>
                        <textarea id="intentOutput" rows="4" placeholder="مثال: نحن نفتح من الساعة 9 صباحاً حتى 6 مساءً، من الأحد إلى الخميس." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button id="addIntentBtn" class="flex-1 bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 shadow-md">إضافة النية لليلى</button>
                        <button id="updateIntentBtn" class="flex-1 bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-200 shadow-md hidden">تحديث النية</button>
                        <button id="cancelEditIntentBtn" class="flex-1 bg-gray-400 text-white p-3 rounded-lg font-semibold hover:bg-gray-500 transition duration-200 shadow-md hidden">إلغاء التعديل</button>
                    </div>
                </section>

                <!-- Train Layla: Add New Product Section -->
                <section class="bg-gray-50 p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">تدريب ليلى: إضافة منتج جديد</h2>
                    <div class="mb-4">
                        <label for="productName" class="block text-sm font-medium text-gray-700 mb-1">اسم المنتج:</label>
                        <input type="text" id="productName" placeholder="مثال: رواية العجوز والبحر" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="productType" class="block text-sm font-medium text-gray-700 mb-1">نوع المنتج:</label>
                        <input type="text" id="productType" placeholder="مثال: رواية، أدبي، خيال علمي، إلكترونيات" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="productDescription" class="block text-sm font-medium text-gray-700 mb-1">وصف المنتج:</label>
                        <textarea id="productDescription" rows="3" placeholder="مثال: قصة كلاسيكية عن الصياد العجوز وكفاحه مع سمكة المارلين العملاقة." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div class="mb-4">
                        <label for="productImageUrl" class="block text-sm font-medium text-gray-700 mb-1">رابط صورة المنتج (اختياري):</label>
                        <input type="url" id="productImageUrl" placeholder="مثال: https://example.com/image.jpg" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label for="productPrice" class="block text-sm font-medium text-gray-700 mb-1">السعر:</label>
                            <input type="text" id="productPrice" placeholder="مثال: 25 دولار" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="productAvailability" class="block text-sm font-medium text-gray-700 mb-1">التوفر:</label>
                            <select id="productAvailability" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="متوفر">متوفر</option>
                                <option value="غير متوفر">غير متوفر</option>
                                <option value="قريباً">قريباً</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-6 flex items-center">
                        <input type="checkbox" id="productIsOffer" class="h-4 w-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                        <label for="productIsOffer" class="ml-2 block text-sm font-medium text-gray-700">هل هو عرض خاص؟</label>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button id="addProductBtn" class="flex-1 bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 shadow-md">إضافة المنتج لليلى</button>
                        <button id="updateProductBtn" class="flex-1 bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-200 shadow-md hidden">تحديث المنتج</button>
                        <button id="cancelEditProductBtn" class="flex-1 bg-gray-400 text-white p-3 rounded-lg font-semibold hover:bg-gray-500 transition duration-200 shadow-md hidden">إلغاء التعديل</button>
                    </div>
                </section>

                <!-- Store Notes Section -->
                <section class="bg-gray-50 p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">ملاحظات المتجر</h2>
                    <div class="mb-4">
                        <label for="noteTitle" class="block text-sm font-medium text-gray-700 mb-1">عنوان الملاحظة (اختياري):</label>
                        <input type="text" id="noteTitle" placeholder="مثال: إعلان هام" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="noteContent" class="block text-sm font-medium text-gray-700 mb-1">محتوى الملاحظة:</label>
                        <textarea id="noteContent" rows="4" placeholder="مثال: خصومات 20% على جميع الروايات هذا الأسبوع!" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button id="addNoteBtn" class="flex-1 bg-indigo-600 text-white p-3 rounded-lg font-semibold hover:bg-indigo-700 transition duration-200 shadow-md">إضافة ملاحظة</button>
                        <button id="updateNoteBtn" class="flex-1 bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-200 shadow-md hidden">تحديث ملاحظة</button>
                        <button id="cancelEditNoteBtn" class="flex-1 bg-gray-400 text-white p-3 rounded-lg font-semibold hover:bg-gray-500 transition duration-200 shadow-md hidden">إلغاء التعديل</button>
                    </div>
                    <div id="notesList" class="space-y-4 mt-6 max-h-60 overflow-y-auto pr-2">
                        <!-- Notes will be loaded here by JavaScript -->
                        <p class="text-gray-500 text-center">لا توجد ملاحظات حالياً.</p>
                    </div>
                </section>

                <!-- Notifications Management Section -->
                <section class="bg-gray-50 p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">إدارة الإشعارات</h2>
                    <div class="mb-4">
                        <label for="notificationTitle" class="block text-sm font-medium text-gray-700 mb-1">عنوان الإشعار:</label>
                        <input type="text" id="notificationTitle" placeholder="مثال: إشعار جديد" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="mb-4">
                        <label for="notificationContent" class="block text-sm font-medium text-gray-700 mb-1">محتوى الإشعار:</label>
                        <textarea id="notificationContent" rows="4" placeholder="مثال: وصول دفعة جديدة من الروايات!" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <button id="addNotificationBtn" class="flex-1 bg-purple-600 text-white p-3 rounded-lg font-semibold hover:bg-purple-700 transition duration-200 shadow-md">إرسال إشعار</button>
                        <button id="updateNotificationBtn" class="flex-1 bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-200 shadow-md hidden">تحديث إشعار</button>
                        <button id="cancelEditNotificationBtn" class="flex-1 bg-gray-400 text-white p-3 rounded-lg font-semibold hover:bg-gray-500 transition duration-200 shadow-md hidden">إلغاء التعديل</button>
                    </div>
                    <div id="notificationsList" class="space-y-4 mt-6 max-h-60 overflow-y-auto pr-2">
                        <!-- Notifications will be loaded here by JavaScript -->
                        <p class="text-gray-500 text-center">لا توجد إشعارات حالياً.</p>
                    </div>
                </section>

                <!-- Test Layla Section -->
                <section class="bg-gray-50 p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">اختبر ليلى</h2>
                    <div class="mb-4">
                        <label for="testQuery" class="block text-sm font-medium text-gray-700 mb-1">اسأل ليلى:</label>
                        <input type="text" id="testQuery" placeholder="مثال: هل لديكم رواية العجوز والبحر؟" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button id="askLaylaBtn" class="w-full bg-purple-600 text-white p-3 rounded-lg font-semibold hover:bg-purple-700 transition duration-200 shadow-md mb-4">اسأل ليلى</button>
                    <div>
                        <label for="laylaResponse" class="block text-sm font-medium text-gray-700 mb-1">استجابة ليلى:</label>
                        <textarea id="laylaResponse" rows="5" readonly class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-800"></textarea>
                    </div>
                </section>
            </div>

            <!-- Right Column: Display Sections -->
            <div class="space-y-8">
                <!-- Existing Layla Intents Section -->
                <section class="bg-gray-50 p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">نوايا ليلى الموجودة (<span id="intentCount">0</span>)</h2>
                    <div id="intentsList" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                        <!-- Intents will be loaded here by JavaScript -->
                        <p class="text-gray-500 text-center">لا توجد نوايا بعد. أضف نية جديدة لتبدأ!</p>
                    </div>
                </section>

                <!-- Existing Layla Products Section -->
                <section class="bg-gray-50 p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">منتجات ليلى الموجودة (<span id="productCount">0</span>)</h2>
                    <div class="mb-4">
                        <label for="productTypeFilter" class="block text-sm font-medium text-gray-700 mb-1">تصفية حسب النوع:</label>
                        <select id="productTypeFilter" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="">جميع الأنواع</option>
                            <!-- Product types will be loaded here by JavaScript -->
                        </select>
                    </div>
                    <div id="productsList" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                        <!-- Products will be loaded here by JavaScript -->
                        <p class="text-gray-500 text-center">لا توجد منتجات مطابقة لهذا النوع.</p>
                    </div>
                </section>

                <!-- Chat Logs Section - NEW -->
                <section class="bg-gray-50 p-6 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">سجلات دردشة ليلى (<span id="chatLogCount">0</span>)</h2>
                    <div class="mt-4 mb-4 text-center flex justify-center gap-2">
                        <button id="showUnansweredOnlyBtn" class="bg-purple-500 text-white p-2 rounded-lg font-semibold hover:bg-purple-600 transition duration-200 text-sm">عرض الأسئلة غير المجابة فقط</button>
                        <button id="showAllChatsBtn" class="bg-blue-500 text-white p-2 rounded-lg font-semibold hover:bg-blue-600 transition duration-200 text-sm hidden">عرض كل الدردشات</button>
                    </div>
                    <div id="chatLogsList" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                        <!-- سجلات الدردشة ستُحمّل هنا بواسطة JavaScript -->
                        <p class="text-gray-500 text-center">لا توجد سجلات دردشة لعرضها بعد.</p>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, doc, onSnapshot, updateDoc, deleteDoc, query, where, getDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (from your 'store-ced42' project)
        const firebaseConfig = {
            apiKey: "AIzaSyByoPYBjMigsno_66nwa6L4q33shpmJDi8",
            authDomain: "store-ced42.firebaseapp.com",
            projectId: "store-ced42", 
            storageBucket: "store-ced42.firebasestorage.app",
            messagingSenderId: "519838982253",
            appId: "1:519838982253:web:6c466eb08a708f5e4b9f64",
            measurementId: "G-MY39NRV7PE"
        };

        // IMPORTANT: This is your provided User ID for the dashboard to access its own data.
        // Data from the store will also be stored under this userId.
        const ADMIN_USER_ID = "bzC2JV95dGMiuUq6PW2oXmsskRm1"; 

        // The app ID used for the Firestore path. Hardcoded to match where data is stored by the store.
        const APP_ID_FOR_FIRESTORE_PATH = "store-ced42"; 

        let app;
        let db;
        let auth;
        let userId; // This will be the ADMIN_USER_ID for the dashboard

        // State variables for editing and data storage
        let editingIntentId = null;
        let editingProductId = null;
        let editingNoteId = null; 
        let editingNotificationId = null; 
        let allProducts = []; 
        let allChatLogs = []; // To store all fetched chat logs for filtering

        // Get references to UI elements
        const userIdDisplay = document.getElementById('userIdDisplay');
        const messageDisplay = document.getElementById('messageDisplay');

        // Intent form elements
        const intentNameInput = document.getElementById('intentName');
        const trainingPhrasesInput = document.getElementById('trainingPhrases');
        const intentOutputInput = document.getElementById('intentOutput');
        const addIntentBtn = document.getElementById('addIntentBtn');
        const updateIntentBtn = document.getElementById('updateIntentBtn');
        const cancelEditIntentBtn = document.getElementById('cancelEditIntentBtn');
        const intentsList = document.getElementById('intentsList');
        const intentCountSpan = document.getElementById('intentCount');

        // Product form elements
        const productNameInput = document.getElementById('productName');
        const productTypeInput = document.getElementById('productType');
        const productDescriptionInput = document.getElementById('productDescription');
        const productImageUrlInput = document.getElementById('productImageUrl'); 
        const productPriceInput = document.getElementById('productPrice');
        const productAvailabilitySelect = document.getElementById('productAvailability');
        const productIsOfferCheckbox = document.getElementById('productIsOffer'); 
        const addProductBtn = document.getElementById('addProductBtn');
        const updateProductBtn = document.getElementById('updateProductBtn');
        const cancelEditProductBtn = document.getElementById('cancelEditProductBtn');
        const productsList = document.getElementById('productsList');
        const productCountSpan = document.getElementById('productCount');
        const productTypeFilter = document.getElementById('productTypeFilter');

        // Store Notes elements
        const noteTitleInput = document.getElementById('noteTitle');
        const noteContentInput = document.getElementById('noteContent');
        const addNoteBtn = document.getElementById('addNoteBtn');
        const updateNoteBtn = document.getElementById('updateNoteBtn');
        const cancelEditNoteBtn = document.getElementById('cancelEditNoteBtn');
        const notesList = document.getElementById('notesList');

        // Notifications Management elements
        const notificationTitleInput = document.getElementById('notificationTitle');
        const notificationContentInput = document.getElementById('notificationContent');
        const addNotificationBtn = document.getElementById('addNotificationBtn');
        const updateNotificationBtn = document.getElementById('updateNotificationBtn');
        const cancelEditNotificationBtn = document.getElementById('cancelEditNotificationBtn');
        const notificationsList = document.getElementById('notificationsList');

        // Test AI elements
        const testQueryInput = document.getElementById('testQuery');
        const askLaylaBtn = document.getElementById('askLaylaBtn');
        const laylaResponseTextarea = document.getElementById('laylaResponse');

        // Chat Logs elements - NEW
        const chatLogsList = document.getElementById('chatLogsList');
        const chatLogCountSpan = document.getElementById('chatLogCount');
        const showUnansweredOnlyBtn = document.getElementById('showUnansweredOnlyBtn');
        const showAllChatsBtn = document.getElementById('showAllChatsBtn');

        /**
         * Displays a message to the user in the message display area.
         * @param {string} message - The message to display.
         * @param {'success'|'error'|'info'} type - The type of message (determines color).
         */
        function showMessage(message, type) {
            messageDisplay.textContent = message;
            messageDisplay.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800');
            if (type === 'success') {
                messageDisplay.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                messageDisplay.classList.add('bg-red-100', 'text-red-800');
            } else {
                messageDisplay.classList.add('bg-blue-100', 'text-blue-800');
            }
            // Hide message after 5 seconds
            setTimeout(() => {
                messageDisplay.classList.add('hidden');
            }, 5000);
        }

        /**
         * Initializes Firebase and handles user authentication.
         */
        async function initializeFirebase() {
            try {
                // Use Canvas provided config if available, otherwise use the hardcoded one
                const currentFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
                
                if (!currentFirebaseConfig.projectId || !currentFirebaseConfig.apiKey || currentFirebaseConfig.apiKey === "YOUR_API_KEY") {
                    showMessage('خطأ: يرجى تحديث firebaseConfig في الكود الخاص بك بمعلومات مشروع Firebase الفعلية.', 'error');
                    return;
                }

                app = initializeApp(currentFirebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                console.log("Firebase initialized. Waiting for auth state...");

                // Listen for authentication state changes
                onAuthStateChanged(auth, async (user) => {
                    console.log("onAuthStateChanged triggered. User:", user);
                    if (user) {
                        console.log("User is signed in. Actual Firebase UID:", user.uid);

                        // For this dashboard, we enforce using ADMIN_USER_ID for data storage
                        userId = ADMIN_USER_ID; 
                        userIdDisplay.textContent = userId;
                        showMessage('تم تسجيل الدخول بنجاح. معرف المستخدم (للتخزين): ' + userId, 'success');
                        
                        // Check if the authenticated user is the ADMIN_USER_ID
                        if (user.uid !== ADMIN_USER_ID) {
                            console.warn("Authenticated UID (" + user.uid + ") does NOT match ADMIN_USER_ID (" + ADMIN_USER_ID + "). Read operations should work (per rules), but write operations (add/update/delete) might fail due to security rules.");
                            showMessage('تحذير: تم تسجيل الدخول كمستخدم مختلف عن المسؤول. قد لا تتمكن من حفظ التغييرات.', 'info');
                        }
                        
                        // Setup Firestore listeners only after app is initialized AND user is authenticated
                        setupFirestoreListeners();
                        setupChatLogsListener(); // NEW: Call setupChatLogsListener here
                    } else {
                        console.log("No user signed in. Attempting anonymous sign-in or custom token sign-in.");
                        try {
                            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                            if (initialAuthToken) {
                                console.log("Attempting signInWithCustomToken with provided token.");
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                console.log("Attempting signInAnonymously.");
                                await signInAnonymously(auth);
                            }
                            // onAuthStateChanged will be triggered again with the new user
                        } catch (anonymousAuthError) {
                            showMessage(`خطأ في تسجيل الدخول: ${anonymousAuthError.message}`, 'error');
                            console.error("Authentication error:", anonymousAuthError);
                        }
                    }
                });

            } catch (error) {
                showMessage(`خطأ في تهيئة Firebase: ${error.message}`, 'error');
                console.error("Firebase initialization error:", error);
            }
        }

        /**
         * Sets up real-time listeners for Intents, Products, Notes, and Notifications collections.
         */
        function setupFirestoreListeners() {
            // Ensure db and userId are available before setting up listeners
            if (!db || !userId || !auth.currentUser) { 
                console.warn("Firestore, userId, or authenticated user not fully ready for listeners in setupFirestoreListeners. Skipping.");
                return;
            }
            console.log(`Setting up Firestore listeners for path: artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/...`);

            // Listen for changes in 'store_intents' collection
            const intentsCollectionRef = collection(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/store_intents`);
            onSnapshot(intentsCollectionRef, (snapshot) => {
                intentsList.innerHTML = ''; 
                const intents = [];
                snapshot.forEach(doc => {
                    intents.push({ id: doc.id, ...doc.data() });
                });
                displayIntents(intents);
                intentCountSpan.textContent = intents.length;
                if (intents.length === 0) {
                    intentsList.innerHTML = '<p class="text-gray-500 text-center">لا توجد نوايا بعد. أضف نية جديدة لتبدأ!</p>';
                }
                console.log("Intents fetched successfully.");
            }, (error) => {
                showMessage(`خطأ في جلب النوايا: ${error.message}`, 'error');
                console.error("Error fetching intents:", error);
            });

            // Listen for changes in 'store_products' collection
            const productsCollectionRef = collection(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/store_products`);
            onSnapshot(productsCollectionRef, (snapshot) => {
                allProducts = []; 
                const productTypes = new Set(); 
                snapshot.forEach(doc => {
                    const productData = { id: doc.id, ...doc.data() };
                    allProducts.push(productData);
                    if (productData.type) {
                        productTypes.add(productData.type);
                    }
                });
                populateProductTypeFilter(Array.from(productTypes));
                filterAndDisplayProducts(); 
                console.log("Products fetched successfully.");
            }, (error) => {
                showMessage(`خطأ في جلب المنتجات: ${error.message}`, 'error');
                console.error("Error fetching products:", error);
            });

            // Listen for changes in 'store_notes' collection
            const notesCollectionRef = collection(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/store_notes`);
            onSnapshot(notesCollectionRef, (snapshot) => {
                notesList.innerHTML = '';
                if (snapshot.empty) {
                    notesList.innerHTML = '<p class="text-gray-500 text-center">لا توجد ملاحظات حالياً.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const noteData = { id: doc.id, ...doc.data() };
                    const noteDiv = document.createElement('div');
                    noteDiv.classList.add('bg-white', 'p-4', 'rounded-lg', 'shadow-sm', 'border', 'border-gray-200');
                    noteDiv.innerHTML = `
                        <h3 class="text-lg font-semibold text-gray-900 mb-1">${noteData.title || 'ملاحظة بدون عنوان'}</h3>
                        <p class="text-sm text-gray-700 mb-3">${noteData.content}</p>
                        <div class="flex gap-2">
                            <button data-id="${noteData.id}" class="edit-note-btn bg-yellow-500 text-white px-3 py-1 rounded-md text-sm hover:bg-yellow-600 transition duration-200">تعديل</button>
                            <button data-id="${noteData.id}" class="delete-note-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600 transition duration-200">حذف</button>
                        </div>
                    `;
                    notesList.appendChild(noteDiv);
                });
                document.querySelectorAll('.edit-note-btn').forEach(button => {
                    button.onclick = (e) => editNote(e.target.dataset.id);
                });
                document.querySelectorAll('.delete-note-btn').forEach(button => {
                    button.onclick = (e) => deleteNote(e.target.dataset.id);
                });
                console.log("Notes fetched successfully.");
            }, (error) => {
                showMessage(`خطأ في جلب الملاحظات: ${error.message}`, 'error');
                console.error("Error fetching notes:", error);
            });

            // Listen for changes in 'store_notifications' collection
            const notificationsCollectionRef = collection(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/store_notifications`);
            onSnapshot(notificationsCollectionRef, (snapshot) => {
                notificationsList.innerHTML = '';
                if (snapshot.empty) {
                    notificationsList.innerHTML = '<p class="text-gray-500 text-center">لا توجد إشعارات حالياً.</p>';
                    return;
                }
                snapshot.forEach(doc => {
                    const notifData = { id: doc.id, ...doc.data() };
                    const notifDiv = document.createElement('div');
                    notifDiv.classList.add('bg-white', 'p-4', 'rounded-lg', 'shadow-sm', 'border', 'border-gray-200');
                    notifDiv.innerHTML = `
                        <h3 class="text-lg font-semibold text-gray-900 mb-1">${notifData.title || 'إشعار بدون عنوان'}</h3>
                        <p class="text-sm text-gray-700 mb-3">${notifData.content}</p>
                        <div class="flex gap-2">
                            <button data-id="${notifData.id}" class="edit-notification-btn bg-yellow-500 text-white px-3 py-1 rounded-md text-sm hover:bg-yellow-600 transition duration-200">تعديل</button>
                            <button data-id="${notifData.id}" class="delete-notification-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600 transition duration-200">حذف</button>
                        </div>
                    `;
                    notificationsList.appendChild(notifDiv);
                });
                document.querySelectorAll('.edit-notification-btn').forEach(button => {
                    button.onclick = (e) => editNotification(e.target.dataset.id);
                });
                document.querySelectorAll('.delete-notification-btn').forEach(button => {
                    button.onclick = (e) => deleteNotification(e.target.dataset.id);
                });
                console.log("Notifications fetched successfully for dashboard.");
            }, (error) => {
                showMessage(`خطأ في جلب الإشعارات: ${error.message}`, 'error');
                console.error("Error fetching notifications:", error);
            });
        }

        /**
         * Sets up real-time listener for 'chat_logs' collection.
         * NEW FUNCTION FOR CHAT LOGS
         */
        function setupChatLogsListener() {
            // Ensure db and userId are available before setting up listeners
            if (!db || !userId || !auth.currentUser) { 
                console.warn("Firestore, userId, or authenticated user not fully ready for chat logs listener. Skipping setup.");
                return;
            }
            console.log(`Setting up Firestore listener for chat logs path: artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/chat_logs`);

            const chatLogsCollectionRef = collection(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/chat_logs`);
            onSnapshot(chatLogsCollectionRef, (snapshot) => {
                allChatLogs = [];
                snapshot.forEach(doc => {
                    allChatLogs.push({ id: doc.id, ...doc.data() });
                });
                // Display all by default when initially loaded or updated
                displayChatLogs(allChatLogs); 
                console.log("Chat logs fetched successfully.");
            }, (error) => {
                showMessage(`خطأ في جلب سجلات الدردشة: ${error.message}`, 'error');
                console.error("Error fetching chat logs:", error);
            });
        }

        /**
         * Displays the list of chat logs in the UI.
         * @param {Array<Object>} logs - Array of chat log objects from Firestore.
         * NEW FUNCTION FOR CHAT LOGS
         */
        function displayChatLogs(logs) {
            chatLogsList.innerHTML = ''; // Clear current list
            chatLogCountSpan.textContent = logs.length; // Update count

            if (logs.length === 0) {
                chatLogsList.innerHTML = '<p class="text-gray-500 text-center">لا توجد سجلات دردشة لعرضها بعد.</p>';
                return;
            }

            // Sort logs by timestamp (newest first)
            logs.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

            logs.forEach(log => {
                const logDiv = document.createElement('div');
                logDiv.classList.add('bg-white', 'p-4', 'rounded-lg', 'shadow-sm', 'border', 'border-gray-200');
                
                let statusClass = 'text-green-600'; // Default for answered
                let statusText = 'تم الرد';
                if (log.unanswered) { // Assuming a boolean field 'unanswered' in your log
                    statusClass = 'text-red-600';
                    statusText = 'لم يتم الرد (يحتاج مراجعة)';
                }

                // Format timestamp for display
                const logTime = log.timestamp ? new Date(log.timestamp.toDate()).toLocaleString('ar-EG', {
                    year: 'numeric', month: 'short', day: 'numeric',
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                }) : 'غير معروف';

                logDiv.innerHTML = `
                    <p class="text-sm text-gray-500 mb-1">
                        <span class="font-semibold">الوقت:</span> ${logTime}
                    </p>
                    <p class="text-base font-semibold text-gray-900 mb-2">
                        <span class="font-semibold">سؤال المستخدم:</span> ${log.userQuery}
                    </p>
                    <p class="text-sm text-gray-700 mb-2">
                        <span class="font-semibold">استجابة ليلى:</span> ${log.laylaResponse}
                    </p>
                    <p class="text-xs ${statusClass} font-semibold">
                        الحالة: ${statusText}
                    </p>
                `;
                chatLogsList.appendChild(logDiv);
            });
        }

        // Event Listeners for chat log filter buttons - NEW
        showUnansweredOnlyBtn.onclick = () => {
            const unansweredLogs = allChatLogs.filter(log => log.unanswered);
            displayChatLogs(unansweredLogs);
            showUnansweredOnlyBtn.classList.add('hidden');
            showAllChatsBtn.classList.remove('hidden');
        };

        showAllChatsBtn.onclick = () => {
            displayChatLogs(allChatLogs);
            showAllChatsBtn.classList.add('hidden');
            showUnansweredOnlyBtn.classList.remove('hidden');
        };

        /**
         * Populates the product type filter dropdown.
         * @param {string[]} types - Array of unique product types.
         */
        function populateProductTypeFilter(types) {
            productTypeFilter.innerHTML = '<option value="">جميع الأنواع</option>';
            types.sort().forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                productTypeFilter.appendChild(option);
            });
            // Restore selected filter if it was set
            if (productTypeFilter.dataset.currentFilter) {
                productTypeFilter.value = productTypeFilter.dataset.currentFilter;
            }
        }

        /**
         * Filters and displays products based on the selected type.
         */
        function filterAndDisplayProducts() {
            productsList.innerHTML = ''; // Clear current list
            const selectedType = productTypeFilter.value;
            productTypeFilter.dataset.currentFilter = selectedType; // Store current filter

            const filteredProducts = selectedType
                ? allProducts.filter(product => product.type === selectedType)
                : allProducts;

            displayProducts(filteredProducts);
            productCountSpan.textContent = filteredProducts.length;

            if (filteredProducts.length === 0) {
                productsList.innerHTML = '<p class="text-gray-500 text-center">لا توجد منتجات مطابقة لهذا النوع.</p>';
            }
        }

        /**
         * Displays the list of intents in the UI.
         * @param {Array<Object>} intents - Array of intent objects from Firestore.
         */
        function displayIntents(intents) {
            intentsList.innerHTML = '';
            intents.forEach(intent => {
                const intentDiv = document.createElement('div');
                intentDiv.id = `intent-${intent.id}`;
                intentDiv.classList.add('bg-white', 'p-4', 'rounded-lg', 'shadow-sm', 'border', 'border-gray-200');
                intentDiv.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-900 mb-1">${intent.name}</h3>
                    <p class="text-sm text-gray-600 mb-2"><strong>عبارات التدريب:</strong> ${intent.trainingPhrases.join(', ')}</p>
                    <p class="text-sm text-gray-700 mb-3"><strong>المخرج:</strong> ${intent.output}</p>
                    <div class="flex gap-2">
                        <button data-id="${intent.id}" class="edit-intent-btn bg-yellow-500 text-white px-3 py-1 rounded-md text-sm hover:bg-yellow-600 transition duration-200">تعديل</button>
                        <button data-id="${intent.id}" class="delete-intent-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600 transition duration-200">حذف</button>
                    </div>
                `;
                intentsList.appendChild(intentDiv);
            });

            // Add event listeners to new buttons
            document.querySelectorAll('.edit-intent-btn').forEach(button => {
                button.onclick = (e) => editIntent(e.target.dataset.id);
            });
            document.querySelectorAll('.delete-intent-btn').forEach(button => {
                button.onclick = (e) => deleteIntent(e.target.dataset.id);
            });
        }

        /**
         * Displays the list of products in the UI.
         * @param {Array<Object>} products - Array of product objects from Firestore.
         */
        function displayProducts(products) {
            productsList.innerHTML = '';
            products.forEach(product => {
                const productDiv = document.createElement('div');
                productDiv.id = `product-${product.id}`;
                productDiv.classList.add('bg-white', 'p-4', 'rounded-lg', 'shadow-sm', 'border', 'border-gray-200');
                productDiv.innerHTML = `
                    <h3 class="text-lg font-semibold text-gray-900 mb-1">${product.name}</h3>
                    <p class="text-sm text-gray-600 mb-1"><strong>النوع:</strong> ${product.type || 'غير محدد'}</p>
                    <p class="text-sm text-gray-700 mb-1"><strong>الوصف:</strong> ${product.description}</p>
                    <p class="text-sm text-gray-700 mb-1"><strong>الصورة:</strong> ${product.imageUrl ? `<a href="${product.imageUrl}" target="_blank" class="text-blue-500 hover:underline">عرض الصورة</a>` : 'لا توجد'}</p>
                    <p class="text-sm text-gray-700 mb-1"><strong>السعر:</strong> ${product.price}</p>
                    <p class="text-sm ${product.availability === 'متوفر' ? 'text-green-600' : product.availability === 'غير متوفر' ? 'text-red-600' : 'text-blue-600'} font-medium mb-1">
                        <strong>التوفر:</strong> ${product.availability}
                    </p>
                    <p class="text-sm text-gray-700 mb-3">
                        <strong>عرض خاص:</strong> ${product.isOffer ? 'نعم' : 'لا'}
                    </p>
                    <div class="flex gap-2">
                        <button data-id="${product.id}" class="edit-product-btn bg-yellow-500 text-white px-3 py-1 rounded-md text-sm hover:bg-yellow-600 transition duration-200">تعديل</button>
                        <button data-id="${product.id}" class="delete-product-btn bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600 transition duration-200">حذف</button>
                    </div>
                `;
                productsList.appendChild(productDiv);
            });

            // Add event listeners to new buttons
            document.querySelectorAll('.edit-product-btn').forEach(button => {
                button.onclick = (e) => editProduct(e.target.dataset.id);
            });
            document.querySelectorAll('.delete-product-btn').forEach(button => {
                button.onclick = (e) => deleteProduct(e.target.dataset.id);
            });
        }

        /**
         * Adds a new intent to Firestore.
         */
        addIntentBtn.onclick = async () => {
            const name = intentNameInput.value.trim();
            const trainingPhrasesText = trainingPhrasesInput.value.trim();
            const output = intentOutputInput.value.trim();

            if (!name || !trainingPhrasesText || !output) {
                showMessage('الرجاء ملء جميع حقول النية.', 'error');
                return;
            }

            const trainingPhrases = trainingPhrasesText.split(/[\n,]+/).map(phrase => phrase.trim()).filter(phrase => phrase !== '');

            try {
                await addDoc(collection(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/store_intents`), {
                    name,
                    trainingPhrases,
                    output,
                    createdAt: new Date()
                });
                showMessage('تمت إضافة النية بنجاح!', 'success');
                // Clear form
                intentNameInput.value = '';
                trainingPhrasesInput.value = '';
                intentOutputInput.value = '';
            } catch (e) {
                showMessage(`خطأ في إضافة النية: ${e.message}`, 'error');
                console.error("Error adding intent:", e);
            }
        };

        /**
         * Populates the intent form for editing.
         * @param {string} id - The ID of the intent to edit.
         */
        async function editIntent(id) {
            try {
                const docRef = doc(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/store_intents`, id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    intentNameInput.value = data.name;
                    trainingPhrasesInput.value = data.trainingPhrases.join(', ');
                    intentOutputInput.value = data.output;
                    editingIntentId = id; // Set the ID of the intent being edited

                    // Show update/cancel buttons, hide add button
                    addIntentBtn.classList.add('hidden');
                    updateIntentBtn.classList.remove('hidden');
                    cancelEditIntentBtn.classList.remove('hidden');
                    showMessage('يمكنك الآن تعديل النية.', 'info');
                } else {
                    showMessage('النية غير موجودة.', 'error');
                }
            } catch (e) {
                showMessage(`خطأ في جلب النية للتعديل: ${e.message}`, 'error');
                console.error("Error fetching intent for edit:", e);
            }
        }

        /**
         * Updates an existing intent in Firestore.
         */
        updateIntentBtn.onclick = async () => {
            if (!editingIntentId) {
                showMessage('لا توجد نية لتحديثها.', 'error');
                return;
            }

            const name = intentNameInput.value.trim();
            const trainingPhrasesText = trainingPhrasesInput.value.trim();
            const output = intentOutputInput.value.trim();

            if (!name || !trainingPhrasesText || !output) {
                showMessage('الرجاء ملء جميع حقول النية.', 'error');
                return;
            }

            const trainingPhrases = trainingPhrasesText.split(/[\n,]+/).map(phrase => phrase.trim()).filter(phrase => phrase !== '');

            try {
                const docRef = doc(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/store_intents`, editingIntentId);
                await updateDoc(docRef, {
                    name,
                    trainingPhrases,
                    output,
                    updatedAt: new Date()
                });
                showMessage('تم تحديث النية بنجاح!', 'success');
                cancelEditIntent(); // Reset form state
            } catch (e) {
                showMessage(`خطأ في تحديث النية: ${e.message}`, 'error');
                console.error("Error updating intent:", e);
            }
        };

        /**
         * Resets the intent form and hides update/cancel buttons.
         */
        cancelEditIntentBtn.onclick = cancelEditIntent;
        function cancelEditIntent() {
            intentNameInput.value = '';
            trainingPhrasesInput.value = '';
            intentOutputInput.value = '';
            editingIntentId = null;
            addIntentBtn.classList.remove('hidden');
            updateIntentBtn.classList.add('hidden');
            cancelEditIntentBtn.classList.add('hidden');
            showMessage('تم إلغاء التعديل.', 'info');
        }

        /**
         * Deletes an intent from Firestore.
         * @param {string} id - The ID of the intent to delete.
         */
        async function deleteIntent(id) {
            // In a real app, you might want a confirmation dialog here.
            try {
                const docRef = doc(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/store_intents`, id);
                await deleteDoc(docRef);
                showMessage('تم حذف النية بنجاح!', 'success');
                if (editingIntentId === id) { // If deleting the one being edited
                    cancelEditIntent();
                }
            } catch (e) {
                showMessage(`خطأ في حذف النية: ${e.message}`, 'error');
                console.error("Error deleting intent:", e);
            }
        }

        /**
         * Adds a new product to Firestore.
         */
        addProductBtn.onclick = async () => {
            const name = productNameInput.value.trim();
            const type = productTypeInput.value.trim();
            const description = productDescriptionInput.value.trim();
            const imageUrl = productImageUrlInput.value.trim(); 
            const price = productPriceInput.value.trim();
            const availability = productAvailabilitySelect.value;
            const isOffer = productIsOfferCheckbox.checked; 

            if (!name || !description || !price || !availability) {
                showMessage('الرجاء ملء جميع حقول المنتج الأساسية.', 'error');
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/store_products`), {
                    name,
                    type,
                    description,
                    imageUrl, 
                    price,
                    availability,
                    isOffer, 
                    createdAt: new Date()
                });
                showMessage('تمت إضافة المنتج بنجاح!', 'success');
                // Clear form
                productNameInput.value = '';
                productTypeInput.value = '';
                productDescriptionInput.value = '';
                productImageUrlInput.value = '';
                productPriceInput.value = '';
                productAvailabilitySelect.value = 'متوفر';
                productIsOfferCheckbox.checked = false; 
            } catch (e) {
                showMessage(`خطأ في إضافة المنتج: ${e.message}`, 'error');
                console.error("Error adding product:", e);
            }
        };

        /**
         * Populates the product form for editing.
         * @param {string} id - The ID of the product to edit.
         */
        async function editProduct(id) {
            try {
                const docRef = doc(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/store_products`, id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    productNameInput.value = data.name;
                    productTypeInput.value = data.type || '';
                    productDescriptionInput.value = data.description;
                    productImageUrlInput.value = data.imageUrl || ''; 
                    productPriceInput.value = data.price;
                    productAvailabilitySelect.value = data.availability;
                    productIsOfferCheckbox.checked = data.isOffer || false; 
                    editingProductId = id; 

                    addProductBtn.classList.add('hidden'); 
                    updateProductBtn.classList.remove('hidden');
                    cancelEditProductBtn.classList.remove('hidden');
                    showMessage('يمكنك الآن تعديل المنتج.', 'info');
                } else {
                    showMessage('المنتج غير موجود.', 'error');
                }
            } catch (e) {
                showMessage(`خطأ في جلب المنتج للتعديل: ${e.message}`, 'error');
                console.error("Error fetching product for edit:", e);
            }
        }

        /**
         * Updates an existing product in Firestore.
         */
        updateProductBtn.onclick = async () => {
            if (!editingProductId) {
                showMessage('لا يوجد منتج لتحديثه.', 'error');
                return;
            }

            const name = productNameInput.value.trim();
            const type = productTypeInput.value.trim();
            const description = productDescriptionInput.value.trim();
            const imageUrl = productImageUrlInput.value.trim(); 
            const price = productPriceInput.value.trim();
            const availability = productAvailabilitySelect.value;
            const isOffer = productIsOfferCheckbox.checked; 

            if (!name || !description || !price || !availability) {
                showMessage('الرجاء ملء جميع حقول المنتج الأساسية.', 'error');
                return;
            }

            try {
                const docRef = doc(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/store_products`, editingProductId);
                await updateDoc(docRef, {
                    name,
                    type,
                    description,
                    imageUrl, 
                    price,
                    availability,
                    isOffer, 
                    updatedAt: new Date()
                });
                showMessage('تم تحديث المنتج بنجاح!', 'success');
                cancelEditProduct(); 
            } catch (e) {
                showMessage(`خطأ في تحديث المنتج: ${e.message}`, 'error');
                console.error("Error updating product:", e);
            }
        };

        /**
         * Resets the product form and hides update/cancel buttons.
         */
        cancelEditProductBtn.onclick = cancelEditProduct;
        function cancelEditProduct() {
            productNameInput.value = '';
            productTypeInput.value = '';
            productDescriptionInput.value = '';
            productImageUrlInput.value = ''; 
            productPriceInput.value = '';
            productAvailabilitySelect.value = 'متوفر';
            productIsOfferCheckbox.checked = false; 
            editingProductId = null;
            addProductBtn.classList.remove('hidden');
            updateProductBtn.classList.add('hidden');
            cancelEditProductBtn.classList.add('hidden');
            showMessage('تم إلغاء التعديل.', 'info');
        }

        /**
         * Deletes a product from Firestore.
         * @param {string} id - The ID of the product to delete.
         */
        async function deleteProduct(id) {
            // In a real app, you might want a confirmation dialog here.
            try {
                const docRef = doc(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/store_products`, id);
                await deleteDoc(docRef);
                showMessage('تم حذف المنتج بنجاح!', 'success');
                if (editingProductId === id) { 
                    cancelEditProduct();
                }
            } catch (e) {
                showMessage(`خطأ في حذف المنتج: ${e.message}`, 'error');
                console.error("Error deleting product:", e);
            }
        }

        // --- Store Notes Logic ---
        addNoteBtn.onclick = async () => {
            const title = noteTitleInput.value.trim();
            const content = noteContentInput.value.trim();

            if (!content) {
                showMessage('الرجاء ملء محتوى الملاحظة.', 'error');
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/store_notes`), {
                    title: title || 'ملاحظة بدون عنوان',
                    content,
                    createdAt: new Date()
                });
                showMessage('تمت إضافة الملاحظة بنجاح!', 'success');
                noteTitleInput.value = '';
                noteContentInput.value = '';
            } catch (e) {
                showMessage(`خطأ في إضافة الملاحظة: ${e.message}`, 'error');
                console.error("Error adding note:", e);
            }
        };

        async function editNote(id) {
            try {
                const docRef = doc(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/store_notes`, id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    noteTitleInput.value = data.title || '';
                    noteContentInput.value = data.content;
                    editingNoteId = id;

                    addNoteBtn.classList.add('hidden');
                    updateNoteBtn.classList.remove('hidden');
                    cancelEditNoteBtn.classList.remove('hidden');
                    showMessage('يمكنك الآن تعديل الملاحظة.', 'info');
                } else {
                    showMessage('الملاحظة غير موجودة.', 'error');
                }
            } catch (e) {
                showMessage(`خطأ في جلب الملاحظة للتعديل: ${e.message}`, 'error');
                console.error("Error fetching note for edit:", e);
            }
        }

        updateNoteBtn.onclick = async () => {
            if (!editingNoteId) {
                showMessage('لا توجد ملاحظة لتحديثها.', 'error');
                return;
            }

            const title = noteTitleInput.value.trim();
            const content = noteContentInput.value.trim();

            if (!content) {
                showMessage('الرجاء ملء محتوى الملاحظة.', 'error');
                return;
            }

            try {
                const docRef = doc(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/store_notes`, editingNoteId);
                await updateDoc(docRef, {
                    title: title || 'ملاحظة بدون عنوان',
                    content,
                    updatedAt: new Date()
                });
                showMessage('تم تحديث الملاحظة بنجاح!', 'success');
                cancelEditNote();
            } catch (e) {
                showMessage(`خطأ في تحديث الملاحظة: ${e.message}`, 'error');
                console.error("Error updating note:", e);
            }
        };

        cancelEditNoteBtn.onclick = cancelEditNote;
        function cancelEditNote() {
            noteTitleInput.value = '';
            noteContentInput.value = '';
            editingNoteId = null;
            addNoteBtn.classList.remove('hidden');
            updateNoteBtn.classList.add('hidden');
            cancelEditNoteBtn.classList.add('hidden');
            showMessage('تم إلغاء التعديل.', 'info');
        }

        async function deleteNote(id) {
            try {
                const docRef = doc(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/store_notes`, id);
                await deleteDoc(docRef);
                showMessage('تم حذف الملاحظة بنجاح!', 'success');
                if (editingNoteId === id) {
                    cancelEditNote();
                }
            } catch (e) {
                showMessage(`خطأ في حذف الملاحظة: ${e.message}`, 'error');
                console.error("Error deleting note:", e);
            }
        }

        // --- Notifications Management Logic ---
        addNotificationBtn.onclick = async () => {
            const title = notificationTitleInput.value.trim();
            const content = notificationContentInput.value.trim();

            if (!title || !content) {
                showMessage('الرجاء ملء عنوان ومحتوى الإشعار.', 'error');
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/store_notifications`), {
                    title,
                    content,
                    read: false, 
                    createdAt: new Date()
                });
                showMessage('تم إرسال الإشعار بنجاح!', 'success');
                notificationTitleInput.value = '';
                notificationContentInput.value = '';
            } catch (e) {
                showMessage(`خطأ في إرسال الإشعار: ${e.message}`, 'error');
                console.error("Error adding notification:", e);
            }
        };

        async function editNotification(id) {
            try {
                const docRef = doc(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/store_notifications`, id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    notificationTitleInput.value = data.title || '';
                    notificationContentInput.value = data.content;
                    editingNotificationId = id;

                    addNotificationBtn.classList.add('hidden');
                    updateNotificationBtn.classList.remove('hidden');
                    cancelEditNotificationBtn.classList.remove('hidden');
                    showMessage('يمكنك الآن تعديل الإشعار.', 'info');
                } else {
                    showMessage('الإشعار غير موجود.', 'error');
                }
            } catch (e) {
                showMessage(`خطأ في جلب الإشعار للتعديل: ${e.message}`, 'error');
                console.error("Error fetching notification for edit:", e);
            }
        }

        updateNotificationBtn.onclick = async () => {
            if (!editingNotificationId) {
                showMessage('لا يوجد إشعار لتحديثه.', 'error');
                return;
            }

            const title = notificationTitleInput.value.trim();
            const content = notificationContentInput.value.trim();

            if (!title || !content) {
                showMessage('الرجاء ملء عنوان ومحتوى الإشعار.', 'error');
                return;
            }

            try {
                const docRef = doc(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/store_notifications`, editingNotificationId);
                await updateDoc(docRef, {
                    title,
                    content,
                    updatedAt: new Date()
                });
                showMessage('تم تحديث الإشعار بنجاح!', 'success');
                cancelEditNotification();
            } catch (e) {
                showMessage(`خطأ في تحديث الإشعار: ${e.message}`, 'error');
                console.error("Error updating notification:", e);
            }
        };

        cancelEditNotificationBtn.onclick = cancelEditNotification;
        function cancelEditNotification() {
            notificationTitleInput.value = '';
            notificationContentInput.value = '';
            editingNotificationId = null;
            addNotificationBtn.classList.remove('hidden');
            updateNotificationBtn.classList.add('hidden');
            cancelEditNotificationBtn.classList.add('hidden');
            showMessage('تم إلغاء التعديل.', 'info');
        }

        async function deleteNotification(id) {
            try {
                const docRef = doc(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/store_notifications`, id);
                await deleteDoc(docRef);
                showMessage('تم حذف الإشعار بنجاح!', 'success');
                if (editingNotificationId === id) {
                    cancelEditNotification();
                }
            } catch (e) {
                showMessage(`خطأ في حذف الإشعار: ${e.message}`, 'error');
                console.error("Error deleting notification:", e);
            }
        }

        /**
         * Layla's AI logic to respond to user queries.
         */
        askLaylaBtn.onclick = async () => {
            const queryText = testQueryInput.value.trim().toLowerCase();
            if (!queryText) {
                laylaResponseTextarea.value = 'الرجاء كتابة سؤال لاختبار ليلى.';
                return;
            }

            laylaResponseTextarea.value = 'ليلى تفكر...';

            try {
                // Fetch current intents and products (though onSnapshot keeps them updated, a direct fetch ensures latest state for this single query)
                const intentsSnapshot = await getDocs(collection(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/store_intents`));
                const currentIntents = intentsSnapshot.docs.map(doc => doc.data());

                const productsSnapshot = await getDocs(collection(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/store_products`));
                const currentProducts = productsSnapshot.docs.map(doc => doc.data());

                let response = 'عذراً، لم أفهم سؤالك. هل يمكنك إعادة الصياغة؟'; // Default response
                let answeredSuccessfully = false; // Flag to track if Layla answered

                // 1. Try to match an Intent
                for (const intent of currentIntents) {
                    const trainingPhrases = intent.trainingPhrases.map(p => p.toLowerCase());
                    if (trainingPhrases.some(phrase => queryText.includes(phrase))) {
                        response = intent.output;
                        answeredSuccessfully = true;
                        break;
                    }
                }

                // 2. If no intent matched, try to match a Product
                if (!answeredSuccessfully) { 
                    if (response === 'عذراً، لم أفهم سؤالك. هل يمكنك إعادة الصياغة؟') {
                        for (const product of currentProducts) {
                            const productNameLower = product.name.toLowerCase();
                            const productDescriptionLower = product.description.toLowerCase();
                            const productTypeLower = product.type ? product.type.toLowerCase() : '';

                            if (queryText.includes(productNameLower) ||
                                queryText.includes(productDescriptionLower) ||
                                queryText.includes(productTypeLower)) {
                                response = `بالتأكيد! لدينا "${product.name}" (النوع: ${product.type || 'غير محدد'}). وصف المنتج: "${product.description}". السعر: ${product.price}. حالة التوفر: ${product.availability}.`;
                                answeredSuccessfully = true;
                                break;
                            }
                        }
                    }
                }

                laylaResponseTextarea.value = response;

                // Log this interaction to chat_logs collection
                // Ensure this logging happens only if Firebase is fully initialized and authenticated
                if (db && userId && auth.currentUser) {
                    await addDoc(collection(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/chat_logs`), {
                        userId: auth.currentUser.uid, // Use the actual authenticated UID
                        userQuery: testQueryInput.value.trim(), // Original query
                        laylaResponse: response,
                        unanswered: !answeredSuccessfully, // True if Layla didn't find a specific answer
                        timestamp: Timestamp.now() // Use Timestamp.now() for consistency
                    });
                    console.log("Layla interaction logged to Firestore from dashboard test.");
                } else {
                    console.warn("Firebase not fully ready for logging chat interaction from dashboard test.");
                }

            } catch (e) {
                laylaResponseTextarea.value = `حدث خطأ أثناء محاولة ليلى الرد: ${e.message}`;
                console.error("Error in Layla AI logic:", e);
                // Log error interaction as unanswered
                if (db && userId && auth.currentUser) {
                    await addDoc(collection(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${userId}/chat_logs`), {
                        userId: auth.currentUser.uid,
                        userQuery: testQueryInput.value.trim(),
                        laylaResponse: `حدث خطأ أثناء محاولة ليلى الرد: ${e.message}`,
                        unanswered: true, // Mark as unanswered due to error
                        timestamp: Timestamp.now()
                    });
                    console.log("Error interaction logged to Firestore from dashboard test.");
                } else {
                    console.warn("Firebase not fully ready for logging error chat interaction from dashboard test.");
                }
            }
        };

        // Event listener for product type filter
        productTypeFilter.onchange = filterAndDisplayProducts;

        // Initialize Firebase when the window loads
        window.onload = initializeFirebase;
    </script>
</body>
</html>
