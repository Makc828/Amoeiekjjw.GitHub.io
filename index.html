<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>TERAKS STORE</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts: Cairo for headings, Noto Sans Arabic for body text -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Noto+Sans+Arabic:wght@400;500&display=swap" rel="stylesheet">
    <style>
        /* General App Styling */
        body {
            font-family: 'Noto Sans Arabic', sans-serif; /* Default body font */
            background-color: #f0f2f5; /* Light gray background for app feel */
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scroll, pages will scroll */
            /* Prevent text selection and zoom for native app feel */
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            touch-action: manipulation; /* Disable double tap zoom */
            -webkit-text-size-adjust: 100%; /* Prevent font boosting */
        }

        /* Apply Cairo to headings and prominent text */
        h1, h2, h3, .product-card h3, .price, .total-line span, #checkout-btn, .add-to-cart-btn, 
        .product-card .add-to-cart-btn-card, .product-card .view-details-btn, .nav-item span,
        .app-modal-content h3, .app-modal-content button {
            font-family: 'Cairo', sans-serif;
        }

        /* IMPORTANT: Ensure Font Awesome icons use their correct font */
        .fas {
            font-family: "Font Awesome 6 Free" !important;
            font-weight: 900 !important; /* For solid icons */
        }

        #app-container {
            display: flex;
            flex-direction: column;
            height: 100vh; /* Full viewport height */
            max-width: 500px; /* Max width for mobile-like feel */
            margin: 0 auto; /* Center the app container */
            background-color: white; /* App background */
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1); /* Subtle shadow */
            border-radius: 15px; /* Rounded corners for app container */
            overflow: hidden; /* Hide overflow from pages */
        }

        /* Header Styling */
        header {
            background-color: #6b46c1; /* Purple */
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 10; /* Above content */
            display: flex; /* Use flex for header content */
            justify-content: space-between;
            align-items: center;
        }
        header h1 {
            font-size: 1.8rem; /* Larger title */
            font-weight: bold;
            flex-grow: 1; /* Allow title to take space */
            text-align: center; /* Center the title */
        }
        .header-icons {
            display: flex;
            gap: 1rem;
            font-size: 1.2rem;
        }
        .header-icon-btn {
            background: none;
            border: none;
            color: white;
            position: relative;
            cursor: pointer;
            padding: 0; /* Remove default button padding */
            line-height: 1; /* Ensure icon is centered */
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ef4444; /* Red */
            color: white;
            border-radius: 50%;
            padding: 0.1rem 0.4rem;
            font-size: 0.7rem;
            font-weight: bold;
            line-height: 1;
        }

        /* Page Content Styling */
        .page-content {
            flex-grow: 1;
            overflow-y: auto; /* Enable scrolling for page content */
            background-color: #f0f2f5; /* Page background */
            display: none; /* Hidden by default */
            position: absolute; /* Position for transitions */
            top: 0; 
            left: 0;
            width: 100%;
            height: 100%;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            transform: translateX(100%);
            opacity: 0;
            z-index: 5;
            flex-direction: column;
            /* No padding-bottom here, sticky elements will handle space */
        }
        .page-content.active {
            display: flex; 
            transform: translateX(0);
            opacity: 1;
            position: relative;
            z-index: 6;
        }
        .page-content.slide-out {
            transform: translateX(-100%);
            opacity: 0;
        }
        .page-content.from-left {
            transform: translateX(-100%);
        }
        .page-content.from-left.active {
            transform: translateX(0);
        }
        /* Specific page adjustments */
        #products-page {
            padding-top: 1rem; /* Added padding for content */
        }
        #product-details-page {
            padding-top: 0; /* Header is part of content flow */
        }
        #chat-page, #cart-page {
            padding-top: 1rem; /* Add general top padding for content */
        }


        /* Bottom Navigation Bar */
        #bottom-nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background-color: white;
            border-top: 1px solid #e0e0e0;
            padding: 0.5rem 0;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
            z-index: 20;
            position: relative;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #a0a0a0;
            font-size: 0.75rem;
            cursor: pointer;
            padding: 0.5rem;
            transition: color 0.2s ease-in-out;
            flex: 1;
        }
        .nav-item.active {
            color: #6b46c1;
        }
        .nav-item i {
            font-size: 1.2rem;
            margin-bottom: 0.2rem;
        }
        #chat-nav-item {
            background-color: #6b46c1;
            color: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.8rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transform: translateY(-20%);
            transition: background-color 0.2s ease-in-out;
        }
        #chat-nav-item:hover {
            background-color: #5a32a3;
        }

        /* Product Card Styling */
        .product-card {
            background-color: white;
            border-radius: 10px; /* 10px radius */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: transform 0.2s ease-in-out;
            width: calc(50% - 0.5rem); /* Fixed width - تم تعديل العرض ليكون نصف الشاشة مع مسافة بين البطاقات */
            /* Removed fixed height: height: 240px; */
            margin-bottom: 1rem;
            flex-shrink: 0; /* Prevent shrinking in grid */
        }
        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }
        .product-card img {
            width: 100%; /* 160px */
            height: 140px; /* Adjusted height to allow more space for content */
            object-fit: cover;
            border-bottom: 1px solid #eee;
            border-top-left-radius: 10px; /* Top corners rounded */
            border-top-right-radius: 10px;
        }
        .product-card-info {
            padding: 0.75rem; /* Increased padding */
            width: 100%;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            justify-content: space-between; /* Push buttons to bottom */
        }
        .product-card h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.25rem; /* Reduced margin */
            overflow: hidden; /* Hide overflow */
            text-overflow: ellipsis; /* Add ellipsis */
            display: -webkit-box;
            -webkit-line-clamp: 2; /* Limit to 2 lines */
            -webkit-box-orient: vertical;
            height: 2.8rem; /* Fixed height for two lines */
        }
        .product-card .price {
            font-size: 1.1rem;
            font-weight: bold;
            color: #6b46c1;
            margin-bottom: 0.5rem;
        }
        .product-card .availability {
            padding: 0.3rem 0.6rem; /* Slightly larger padding */
            border-radius: 9999px;
            font-size: 0.75rem; /* Slightly larger font */
            font-weight: 500;
            display: inline-block;
            margin-bottom: 0.5rem;
        }
        .product-card .buttons-container {
            display: flex;
            gap: 0.25rem; /* Smaller gap */
            margin-top: auto; /* Push to bottom */
            width: 100%;
            justify-content: center; /* Center buttons */
        }
        .product-card .buttons-container button {
            padding: 0.5rem 0.6rem; /* Slightly larger padding */
            border-radius: 6px; /* Slightly smaller radius */
            font-weight: 500;
            transition: background-color 0.2s ease-in-out;
            font-size: 0.8rem; /* Slightly larger font size */
            flex: 1; /* Allow buttons to grow */
            max-width: 50%; /* Max width for two buttons */
        }
        .product-card .view-details-btn {
            background-color: transparent; /* No background */
            color: #3b82f6; /* Blue text */
            border: 1px solid #3b82f6; /* Blue border */
        }
        .product-card .view-details-btn:hover {
            background-color: #e0f2fe; /* Light blue hover */
        }
        .product-card .add-to-cart-btn-card {
            background-color: #6b46c1; /* Purple */
            color: white;
            border: 1px solid #6b46c1; /* Purple border */
            width: 30px; /* Fixed width for icon button */
            height: 30px; /* Fixed height for icon button */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.9rem; /* Icon size */
            border-radius: 50%; /* Circular */
            flex: none; /* Don't grow */
        }
        .product-card .add-to-cart-btn-card:hover {
            background-color: #5a32a3;
        }
        /* Adjust display for fixed card size - تم تغيير النظام من Grid إلى Flexbox */
        #products-display {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 1rem; /* Increased gap for better spacing */
            padding: 0 0.5rem 1rem;
            width: 100%;
        }
        /* Ensure no horizontal scroll for products-display */
        #products-page {
            overflow-x: hidden;
        }

        /* Product Details Page Styling */
        #product-details-page .details-header {
            background-color: white;
            padding: 1rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            width: 100%;
            z-index: 10;
        }
        #product-details-page .details-header button {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b46c1;
            padding: 0 10px;
        }
        #product-details-page .details-header h2 {
            flex-grow: 1;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-right: 40px; /* Offset for back button */
        }
        #product-details-page .details-content-wrapper {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            background-color: #f0f2f5;
            padding: 1rem;
        }
        /* Adjusted image size for product details */
        #product-details-page img {
            width: 200px; /* Increased width */
            height: 300px; /* Increased height */
            object-fit: cover;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        #product-details-page h3 {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 0.5rem;
        }
        #product-details-page .type {
            color: #666;
            font-size: 1rem;
            margin-bottom: 1rem;
        }
        #product-details-page .description {
            color: #555;
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 1.5rem;
            max-width: 80%;
        }
        #product-details-page .price {
            font-size: 1.6rem;
            font-weight: bold;
            color: #6b46c1;
            margin-bottom: 1rem;
        }
        #product-details-page .availability {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 1rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 1.5rem;
        }
        #product-details-page .add-to-cart-btn {
            background-color: #6b46c1;
            color: white;
            padding: 0.8rem 2rem;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.1rem;
            transition: background-color 0.2s ease-in-out;
        }
        #product-details-page .add-to-cart-btn:hover {
            background-color: #5a32a3;
        }

        /* Chat Page Styling */
        #chat-page {
            display: flex;
            flex-direction: column;
            height: 100%; /* Ensure chat page takes full height */
        }
        #chat-page .chat-messages-container {
            flex-grow: 1;
            overflow-y: auto;
            background-color: #f3f4f6;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            /* Removed padding-bottom */
        }
        #chat-page .message {
            margin-bottom: 0.75rem;
            padding: 0.6rem 1rem;
            border-radius: 12px;
            max-width: 80%;
            line-height: 1.4;
        }
        #chat-page .user-message {
            background-color: #dbeafe;
            align-self: flex-end;
            margin-right: auto;
            text-align: right;
        }
        #chat-page .layla-message {
            background-color: #e9d5ff;
            align-self: flex-start;
            margin-left: auto;
            text-align: left;
        }
        #chat-page .chat-input-area {
            background-color: white;
            padding: 0.75rem 1rem;
            border-top: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: sticky; /* Make it stick to the bottom */
            bottom: 0; /* Stick to the bottom of its flex container */
            z-index: 7;
            flex-shrink: 0; /* Prevent it from shrinking */
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05); /* Add shadow for separation */
        }
        #chat-page .chat-input-area input {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 1rem;
        }
        #chat-page .chat-input-area button {
            background-color: #6b46c1;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s ease-in-out;
        }
        #chat-page .chat-input-area button:hover {
            background-color: #5a32a3;
        }

        /* Cart Page Styling */
        #cart-page {
            display: flex;
            flex-direction: column;
            height: 100%; /* Ensure cart page takes full height */
        }
        #cart-page .cart-items-container {
            flex-grow: 1;
            overflow-y: auto;
            background-color: #f0f2f5;
            padding: 1rem;
            /* Removed padding-bottom */
        }
        .cart-item {
            background-color: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .cart-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            margin-left: 1rem;
            flex-shrink: 0;
        }
        .cart-item-info {
            flex-grow: 1;
        }
        .cart-item-info h4 {
            font-weight: 600;
            color: #333;
            font-size: 1rem;
        }
        .cart-item-info p {
            color: #666;
            font-size: 0.85rem;
        }
        .cart-item .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 1rem;
        }
        .cart-item .quantity-controls button {
            background-color: #eee;
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 25px;
            height: 25px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1rem;
            cursor: pointer;
        }
        .cart-item .quantity-controls span {
            font-weight: bold;
            font-size: 1rem;
        }
        .cart-item .remove-btn {
            background: none;
            border: none;
            color: #ef4444;
            font-size: 1.2rem;
            cursor: pointer;
            flex-shrink: 0;
        }
        #cart-total-container {
            background-color: white;
            padding: 1rem;
            border-top: 1px solid #eee;
            text-align: center;
            position: sticky; /* Make it stick to the bottom */
            bottom: 0; /* Stick to the bottom of its flex container */
            z-index: 7;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex-shrink: 0; /* Prevent it from shrinking */
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        }
        #cart-total-container .total-line {
            display: flex;
            justify-content: space-between;
            font-size: 1rem; /* Adjusted font size for "الإجمالية" */
            font-weight: bold;
            color: #333;
        }
        #cart-total-container .total-line span:first-child {
            font-size: 0.9rem; /* Smaller font for labels like "المنتجات", "التوصيل" */
        }
        #cart-total-container .total-line span:last-child {
            font-size: 1.1rem; /* Slightly larger for values */
        }
        #cart-total-container .total-line.text-lg { /* For "الإجمالي" line */
            font-size: 1.2rem; /* Adjusted font size for "الإجمالي" */
        }
        #cart-total-container .delivery-note {
            font-size: 0.75rem;
            color: #666;
            margin-top: 0.5rem;
            line-height: 1.3;
        }
        #checkout-btn {
            background-color: #6b46c1;
            color: white;
            padding: 0.6rem 1.2rem; /* Adjusted padding for "الشراء" button */
            border-radius: 10px; /* Slightly smaller border radius */
            font-weight: bold;
            font-size: 1rem; /* Adjusted font size for "الشراء" button */
            transition: background-color 0.2s ease-in-out;
            width: 100%;
            margin-top: 0.8rem; /* Adjusted margin */
        }
        #checkout-btn:hover {
            background-color: #5a32a3;
        }


        /* Store Notes Display */
        #store-notes-display {
            background-color: #fff;
            border-radius: 8px;
            padding: 0.75rem;
            margin: 0.5rem 1rem 1rem 1rem; /* Adjusted top margin to be smaller */
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-size: 0.9rem;
            color: #333;
            text-align: center;
            line-height: 1.4; /* Ensure full visibility for multi-line */
            white-space: normal; /* Allow wrapping */
            overflow: hidden; /* Hide overflow if it somehow still happens */
            text-overflow: ellipsis; /* Add ellipsis if it truncates */
        }

        /* Modals (Checkout, Notifications, Privacy Policy) */
        .app-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000; /* High z-index */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .app-modal.open {
            opacity: 1;
            visibility: visible;
        }
        .app-modal-content {
            background-color: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .app-modal-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #4a5568;
        }
        .app-modal-close-btn:hover {
            color: #2d3748;
        }
        .app-modal-content input, .app-modal-content textarea, .app-modal-content select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        .app-modal-content button {
            background-color: #6b46c1;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: bold;
            transition: background-color 0.2s ease-in-out;
        }
        .app-modal-content button:hover {
            background-color: #5a32a3;
        }
        .app-modal-content .checkbox-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .app-modal-content .checkbox-container input {
            width: auto;
        }

        /* Notification Modal */
        #notification-modal .notification-item {
            background-color: #f3f4f6;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        #notification-modal .notification-item h4 {
            font-weight: bold;
            margin-bottom: 0.25rem;
            color: #333;
        }
        #notification-modal .notification-item p {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 0.5rem;
        }
        #notification-modal .notification-item .timestamp {
            font-size: 0.75rem;
            color: #888;
            text-align: left; /* Align timestamp to left */
        }
        #notification-modal .no-notifications {
            text-align: center;
            color: #888;
        }

        /* Toast Notification */
        .toast-notification {
            position: fixed;
            top: 20px;
            right: 20px; /* Slide from right for RTL */
            background-color: #6b46c1;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 10001;
            opacity: 0;
            transform: translateX(100%); /* Start off-screen right */
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            max-width: 250px;
        }
        .toast-notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast-notification .toast-title {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Main App Container -->
    <div id="app-container">
        <!-- Header (Common for all main pages) -->
        <header>
            <div class="header-icons">
                <button id="notification-icon" class="header-icon-btn">
                    <i class="fas fa-bell"></i>
                    <span id="notification-badge" class="notification-badge hidden">0</span>
                </button>
                <button id="email-icon" class="header-icon-btn">
                    <i class="fas fa-envelope"></i>
                </button>
                <button id="privacy-policy-icon" class="header-icon-btn">
                    <i class="fas fa-shield-alt"></i>
                </button>
            </div>
            <!-- TERAKS title in the header -->
            <h1 id="header-title" class="text-xl md:text-2xl font-bold text-white flex-grow text-center">متجر TERAKS</h1>
        </header>

        <!-- Products Page -->
        <section id="products-page" class="page-content active">
            <!-- Store Notes Display Area -->
            <div id="store-notes-display" class="hidden">
                <!-- Notes will be loaded here -->
            </div>

            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6 px-4">
                <!-- Search Input -->
                <input type="text" id="productSearchInput" placeholder="ابحث عن منتج..." class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
            </div>
            
            <div class="flex flex-wrap justify-center items-center gap-4 mb-6 px-4">
                <!-- Product Type Filter -->
                <div class="flex items-center gap-2">
                    <label for="productTypeFilterStore" class="text-base font-medium text-gray-700">النوع:</label>
                    <select id="productTypeFilterStore" class="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                        <option value="">جميع الأنواع</option>
                        <!-- Product types will be loaded here by JavaScript -->
                    </select>
                </div>
                <!-- Offers Button -->
                <button id="showOffersBtn" class="bg-purple-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-purple-600 transition duration-200 text-sm flex items-center gap-2">
                    <i class="fas fa-percent"></i>
                    العروض
                </button>
            </div>

            <div id="products-display" class="px-4 flex-grow">
                <!-- Products will be loaded here by JavaScript -->
                <p class="text-center text-gray-500 col-span-full">جاري تحميل المنتجات...</p>
            </div>
        </section>

        <!-- Product Details Page -->
        <section id="product-details-page" class="page-content">
            <div class="details-header">
                <button id="backToProductsBtn"><i class="fas fa-chevron-right"></i></button>
                <h2 id="details-page-title">تفاصيل المنتج</h2>
            </div>
            <div class="details-content-wrapper">
                <img id="details-image" src="" alt="صورة المنتج">
                <h3 id="details-name"></h3>
                <p id="details-type" class="type"></p>
                <p id="details-description" class="description"></p>
                <p id="details-price" class="price"></p>
                <span id="details-availability" class="availability"></span>
                <button id="addToCartBtn" class="add-to-cart-btn">أضف إلى السلة</button>
            </div>
        </section>

        <!-- Chat Page -->
        <section id="chat-page" class="page-content">
            <div id="chat-messages-container" class="chat-messages-container">
                <!-- Chat messages will appear here -->
                <div class="layla-message message">مرحباً! كيف يمكنني مساعدتك اليوم؟</div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="اكتب سؤالك هنا...">
                <button id="send-chat-btn"><i class="fas fa-paper-plane"></i></button>
            </div>
        </section>

        <!-- Cart Page -->
        <section id="cart-page" class="page-content">
            <div id="cart-items-container" class="cart-items-container">
                <!-- Cart items will be loaded here -->
                <p class="text-center text-gray-500">سلتك فارغة حالياً.</p>
            </div>
            <div id="cart-total-container">
                <div class="total-line">
                    <span>المنتجات:</span>
                    <span id="products-subtotal">0.00 IQD</span>
                </div>
                <div class="total-line">
                    <span>التوصيل:</span>
                    <span id="delivery-cost">0.00 IQD</span>
                </div>
                <div class="total-line text-lg font-extrabold text-purple-700">
                    <span>الإجمالي:</span>
                    <span id="final-total">0.00 IQD</span>
                </div>
                <p class="delivery-note">
                    ملاحظات التوصيل: عند طلب كتب: البصرة (3,000 IQD)، باقي محافظات العراق (5,000 IQD).
                    عند طلب منتجات أخرى: الناصرية (3,000 IQD)، باقي محافظات العراق (5,000 IQD).
                </p>
                <button id="checkout-btn">إتمام عملية الشراء</button>
            </div>
        </section>

        <!-- Bottom Navigation Bar -->
        <nav id="bottom-nav">
            <div class="nav-item active" data-page="products-page">
                <i class="fas fa-box"></i>
                <span>المنتجات</span>
            </div>
            <div class="nav-item" data-page="chat-page">
                <div id="chat-nav-item">
                    <i class="fas fa-comment-dots"></i>
                </div>
            </div>
            <div class="nav-item" data-page="cart-page">
                <i class="fas fa-shopping-cart"></i>
                <span>السلة</span>
            </div>
        </nav>
    </div>

    <!-- Checkout Modal -->
    <div id="checkout-modal" class="app-modal">
        <div class="app-modal-content">
            <button class="app-modal-close-btn" id="close-checkout-modal">&times;</button>
            <h3 class="text-xl font-bold text-center mb-4">إتمام عملية الشراء</h3>
            <form id="checkout-form" action="https://formspree.io/f/xvgqkzbo" method="POST"> <!-- REPLACE WITH YOUR FORMSPREE FORM ID -->
                <label for="governorate" class="block text-sm font-medium text-gray-700 mb-1">المحافظة:</label>
                <select id="governorate" name="المحافظة" class="mb-3">
                    <option value="">اختر محافظتك</option>
                    <!-- Governorates will be populated by JS -->
                </select>

                <label for="area" class="block text-sm font-medium text-gray-700 mb-1">المنطقة:</label>
                <input type="text" id="area" name="المنطقة" placeholder="ادخل المنطقة" class="mb-3">

                <label for="landmark" class="block text-sm font-medium text-gray-700 mb-1">أقرب نقطة دالة:</label>
                <input type="text" id="landmark" name="أقرب نقطة دالة" placeholder="مثال: قرب جامع النور" class="mb-3">

                <label for="phoneNumber" class="block text-sm font-medium text-gray-700 mb-1">رقم الهاتف:</label>
                <input type="tel" id="phoneNumber" name="رقم الهاتف" placeholder="مثال: 07701234567" class="mb-3">

                <label for="totalPriceForm" class="block text-sm font-medium text-gray-700 mb-1">السعر الكلي للطلب:</label>
                <input type="text" id="totalPriceForm" name="السعر الكلي للطلب" readonly class="mb-3 bg-gray-100">

                <label for="additionalNotes" class="block text-sm font-medium text-gray-700 mb-1">ملاحظات إضافية (اختياري):</label>
                <textarea id="additionalNotes" name="ملاحظات إضافية" rows="3" placeholder="أي تفاصيل إضافية للطلب" class="mb-3"></textarea>

                <div class="checkbox-container">
                    <input type="checkbox" id="saveAddressCheckbox" class="h-4 w-4">
                    <label for="saveAddressCheckbox" class="text-sm">حفظ العنوان للمرة القادمة</label>
                </div>
                <p id="saveAddressTip" class="text-xs text-gray-500 mt-1 hidden">عند تفعيل هذه الميزة، لن تحتاج لإدخال المعلومات في المرة القادمة، فقط اضغط على زر الشراء.</p>
                <button type="submit" class="mt-4">تأكيد الشراء</button>
            </form>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notification-modal" class="app-modal">
        <div class="app-modal-content">
            <button class="app-modal-close-btn" id="close-notification-modal">&times;</button>
            <h3 class="text-xl font-bold text-center mb-4">الإشعارات</h3>
            <div id="notifications-list" class="flex flex-col gap-3">
                <p class="no-notifications">لا توجد إشعارات حالياً.</p>
            </div>
        </div>
    </div>

    <!-- Privacy Policy Modal -->
    <div id="privacy-policy-modal" class="app-modal">
        <div class="app-modal-content">
            <button class="app-modal-close-btn" id="close-privacy-policy-modal">&times;</button>
            <h3 class="text-xl font-bold text-center mb-4">سياسة الخصوصية</h3>
            <p class="text-gray-700 text-sm leading-relaxed">
                نحن في متجر TERAKS نلتزم بحماية خصوصيتك. يتم استخدام معلوماتك الشخصية فقط لإتمام طلباتك وتحسين تجربتك في المتجر. نحن لا نشارك بياناتك مع أطراف ثالثة.
            </p>
        </div>
    </div>

    <!-- Toast Notification (for new notifications) -->
    <div id="toast-notification" class="toast-notification">
        <i class="fas fa-bell"></i>
        <div>
            <div class="toast-title"></div>
            <div class="toast-content text-xs"></div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, getDocs, doc, updateDoc, enableIndexedDbPersistence, addDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (from your 'store-ced42' project)
        const firebaseConfig = {
            apiKey: "AIzaSyByoPYBjMigsno_66nwa6L4q33shpmJDi8",
            authDomain: "store-ced42.firebaseapp.com",
            projectId: "store-ced42",
            storageBucket: "store-ced42.firebasestorage.app",
            messagingSenderId: "519838982253",
            appId: "1:519838982253:web:6c466eb08a708f5e4b9f64",
            measurementId: "G-MY39NRV7PE"
        };

        // The User ID under which data is stored (from your dashboard)
        // This is the ADMIN_USER_ID from your dashboard, used to fetch intents/products
        const ADMIN_USER_ID = "bzC2JV95dGMiuUq6PW2oXmsskRm1"; 

        // The app ID used for the Firestore path (should match projectId)
        // Using __app_id from Canvas environment if available, otherwise fallback to projectId
        const APP_ID_FOR_FIRESTORE_PATH = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;

        let app;
        let db;
        let auth;
        let clientUserId; // This will be the actual client's UID (anonymous or authenticated)

        let allIntents = [];
        let allProducts = []; 
        let allNotes = []; 
        let allNotifications = []; 
        let unreadNotificationsCount = 0;
        let lastNotificationTimestamp = 0; // To track new notifications

        let currentFilter = 'all'; // 'all', 'offers', or a product type
        let cartItems = []; 

        // UI Elements
        const appContainer = document.getElementById('app-container');
        const headerTitle = document.getElementById('header-title'); 
        const productsPage = document.getElementById('products-page');
        const productDetailsPage = document.getElementById('product-details-page');
        const chatPage = document.getElementById('chat-page');
        const cartPage = document.getElementById('cart-page');
        const pages = document.querySelectorAll('.page-content');
        const bottomNav = document.getElementById('bottom-nav');
        const navItems = document.querySelectorAll('.nav-item');

        const productsDisplay = document.getElementById('products-display');
        const productSearchInput = document.getElementById('productSearchInput'); 
        const productTypeFilterStore = document.getElementById('productTypeFilterStore');
        const showOffersBtn = document.getElementById('showOffersBtn');
        const storeNotesDisplay = document.getElementById('store-notes-display'); 

        // Header Icons
        const notificationIcon = document.getElementById('notification-icon');
        const notificationBadge = document.getElementById('notification-badge');
        const emailIcon = document.getElementById('email-icon');
        const privacyPolicyIcon = document.getElementById('privacy-policy-icon');

        // Product Details Page Elements
        const backToProductsBtn = document.getElementById('backToProductsBtn');
        const detailsPageTitle = document.getElementById('details-page-title');
        const detailsImage = document.getElementById('details-image');
        const detailsName = document.getElementById('details-name');
        const detailsType = document.getElementById('details-type');
        const detailsDescription = document.getElementById('details-description');
        const detailsPrice = document.getElementById('details-price');
        const detailsAvailability = document.getElementById('details-availability');
        const addToCartBtn = document.getElementById('addToCartBtn');

        // Chat Page Elements
        const chatMessagesContainer = document.getElementById('chat-messages-container');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');

        // Cart Page Elements
        const cartItemsContainer = document.getElementById('cart-items-container');
        const cartTotalContainer = document.getElementById('cart-total-container');
        const productsSubtotalDisplay = document.getElementById('products-subtotal');
        const deliveryCostDisplay = document.getElementById('delivery-cost');
        const finalTotalDisplay = document.getElementById('final-total');
        const checkoutBtn = document.getElementById('checkout-btn');

        // Checkout Modal Elements
        const checkoutModal = document.getElementById('checkout-modal');
        const closeCheckoutModalBtn = document.getElementById('close-checkout-modal');
        const checkoutForm = document.getElementById('checkout-form');
        const governorateSelect = document.getElementById('governorate');
        const areaInput = document.getElementById('area');
        const landmarkInput = document.getElementById('landmark');
        const phoneNumberInput = document.getElementById('phoneNumber');
        const totalPriceFormInput = document.getElementById('totalPriceForm');
        const additionalNotesInput = document.getElementById('additionalNotes');
        const saveAddressCheckbox = document.getElementById('saveAddressCheckbox');
        const saveAddressTip = document.getElementById('saveAddressTip');

        // Notification Modal Elements
        const notificationModal = document.getElementById('notification-modal');
        const closeNotificationModalBtn = document.getElementById('close-notification-modal');
        const notificationsList = document.getElementById('notifications-list');

        // Privacy Policy Modal Elements
        const privacyPolicyModal = document.getElementById('privacy-policy-modal');
        const closePrivacyPolicyModalBtn = document.getElementById('close-privacy-policy-modal');

        // Toast Notification Elements
        const toastNotification = document.getElementById('toast-notification');
        const toastTitle = toastNotification.querySelector('.toast-title');
        const toastContent = toastNotification.querySelector('.toast-content');


        // --- Utility Functions ---

        /**
         * Navigates to a specific page.
         * @param {HTMLElement} targetPage - The page element to navigate to.
         * @param {string} title - The title to set for the header.
         * @param {boolean} [isBack=false] - True if navigating back (for animation).
         */
        function navigateTo(targetPage, title, isBack = false) {
            const currentPage = document.querySelector('.page-content.active');
            if (currentPage === targetPage) return;

            if (currentPage) {
                currentPage.classList.remove('active');
                if (!isBack) {
                    currentPage.classList.add('slide-out');
                }
                setTimeout(() => {
                    currentPage.style.display = 'none';
                    currentPage.classList.remove('slide-out', 'from-left');
                }, 300);
            }

            // Always update the header title
            headerTitle.textContent = title;
            
            targetPage.style.display = 'flex';
            setTimeout(() => {
                targetPage.classList.add('active');
                if (isBack) {
                    targetPage.classList.add('from-left');
                } else {
                    targetPage.classList.remove('from-left');
                }
            }, 50);

            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === targetPage.id) {
                    item.classList.add('active');
                }
            });

            if (targetPage === productDetailsPage) {
                bottomNav.style.display = 'none';
            } else {
                bottomNav.style.display = 'flex';
            }
        }

        /**
         * Simple alert message (replaces alert()).
         * @param {string} message
         * @param {'success'|'info'|'error'} type
         */
        function alertMessage(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.classList.add('fixed', 'top-4', 'left-1/2', '-translate-x-1/2', 'z-[10000]', 'px-4', 'py-2', 'rounded-lg', 'text-white', 'font-semibold', 'shadow-lg');
            if (type === 'success') {
                alertDiv.classList.add('bg-green-500');
            } else if (type === 'info') {
                alertDiv.classList.add('bg-blue-500');
            } else {
                alertDiv.classList.add('bg-red-500');
            }
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        /**
         * Shows a modal.
         * @param {HTMLElement} modalElement
         */
        function showModal(modalElement) {
            modalElement.classList.add('open');
            modalElement.classList.remove('hidden');
        }

        /**
         * Hides a modal.
         * @param {HTMLElement} modalElement
         */
        function hideModal(modalElement) {
            modalElement.classList.remove('open');
            setTimeout(() => {
                modalElement.classList.add('hidden');
            }, 300); // Match CSS transition duration
        }

        // --- Firebase Initialization ---
        async function initializeFirebase() {
            try {
                // Use __firebase_config from the Canvas environment if available
                const canvasFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                app = initializeApp(canvasFirebaseConfig);
                db = getFirestore(app);

                // Enable Firebase Offline Persistence
                try {
                    await enableIndexedDbPersistence(db);
                    console.log("Firebase Offline Persistence enabled successfully.");
                } catch (err) {
                    if (err.code === 'failed-precondition') {
                        // Multiple tabs open, persistence can only be enabled in one.
                        console.warn("Firebase Offline Persistence: Can't enable persistence, likely multiple tabs open.");
                    } else if (err.code === 'unimplemented') {
                        // The browser doesn't support all of the features required for persistence.
                        console.warn("Firebase Offline Persistence: Browser does not support persistence.");
                    } else {
                        console.error("Firebase Offline Persistence: Error enabling persistence", err);
                    }
                }

                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        clientUserId = user.uid; // Actual client's UID
                        console.log("Firebase authenticated. Client User ID:", clientUserId);
                        setupFirestoreListeners();
                    } else {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                            clientUserId = auth.currentUser.uid; // Update after sign-in
                            console.log("Signed in with:", clientUserId);
                            setupFirestoreListeners();
                        } catch (error) {
                            console.error("Error signing in anonymously:", error);
                            productsDisplay.innerHTML = '<p class="text-red-500 col-span-full">خطأ في الاتصال بالمتجر. يرجى المحاولة لاحقاً.</p>';
                            addChatMessage("ليلى", "عذراً، لا أستطيع الاتصال بخدماتي حالياً. يرجى المحاولة مرة أخرى لاحقاً.", 'layla-message');
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                productsDisplay.innerHTML = '<p class="text-red-500 col-span-full">خطأ فادح في تهيئة Firebase. يرجى التحقق من الإعدادات.</p>';
                addChatMessage("ليلى", "عذراً، حدث خطأ فادح في تهيئة خدماتي. يرجى إبلاغ إدارة المتجر.", 'layla-message');
            }
        }

        /**
         * Sets up real-time listeners for Products, Intents, Notes, and Notifications collections.
         */
        function setupFirestoreListeners() {
            if (!db || !clientUserId) { // Use clientUserId here
                console.warn("Firestore or clientUserId not ready for listeners.");
                return;
            }

            // Listen for changes in 'store_products' collection (using ADMIN_USER_ID for data source)
            const productsCollectionRef = collection(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${ADMIN_USER_ID}/store_products`);
            onSnapshot(productsCollectionRef, (snapshot) => {
                allProducts = []; 
                const productTypes = new Set(); 
                snapshot.forEach(doc => {
                    const productData = { id: doc.id, ...doc.data() };
                    allProducts.push(productData);
                    if (productData.type) {
                        productTypes.add(productData.type);
                    }
                });
                populateProductTypeFilterStore(Array.from(productTypes)); 
                applyProductFilter(); 
                console.log("Products updated in real-time.");
            }, (error) => {
                console.error("Error fetching products in store:", error);
                productsDisplay.innerHTML = '<p class="text-red-500 col-span-full">خطأ في جلب المنتجات. يرجى المحاولة لاحقاً.</p>';
            });

            // Listen for changes in 'store_intents' collection (for Layla's knowledge, using ADMIN_USER_ID)
            const intentsCollectionRef = collection(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${ADMIN_USER_ID}/store_intents`);
            onSnapshot(intentsCollectionRef, (snapshot) => {
                allIntents = []; 
                snapshot.forEach(doc => {
                    allIntents.push({ id: doc.id, ...doc.data() });
                });
                console.log("Intents updated in real-time for Layla.");
            }, (error) => {
                console.error("Error fetching intents for Layla:", error);
                addChatMessage("ليلى", "عذراً، لا أستطيع الوصول إلى قاعدة معلوماتي حالياً.", 'layla-message');
            });

            // Listen for changes in 'store_notes' collection (using ADMIN_USER_ID)
            const notesCollectionRef = collection(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${ADMIN_USER_ID}/store_notes`);
            onSnapshot(notesCollectionRef, (snapshot) => {
                allNotes = [];
                if (snapshot.empty) {
                    storeNotesDisplay.classList.add('hidden');
                    storeNotesDisplay.innerHTML = '';
                    return;
                }
                storeNotesDisplay.classList.remove('hidden');
                storeNotesDisplay.innerHTML = ''; 
                snapshot.forEach(doc => {
                    const noteData = doc.data();
                    allNotes.push(noteData); 
                    const noteSpan = document.createElement('span');
                    noteSpan.textContent = `${noteData.title ? noteData.title + ': ' : ''}${noteData.content} --- `;
                    storeNotesDisplay.appendChild(noteSpan);
                });
                // No animation, just display full text
            }, (error) => {
                console.error("Error fetching notes for store:", error);
                storeNotesDisplay.classList.add('hidden');
            });

            // Listen for changes in 'store_notifications' collection (using ADMIN_USER_ID)
            const notificationsCollectionRef = collection(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${ADMIN_USER_ID}/store_notifications`);
            onSnapshot(notificationsCollectionRef, (snapshot) => {
                let newUnreadCount = 0;
                let latestNotification = null;
                let currentNotifications = [];

                snapshot.forEach(doc => {
                    const notificationData = { id: doc.id, ...doc.data() };
                    currentNotifications.push(notificationData);
                    if (!notificationData.read) {
                        newUnreadCount++;
                    }
                    const notifTimestamp = notificationData.createdAt?.toDate ? notificationData.createdAt.toDate().getTime() : new Date(notificationData.createdAt).getTime();
                    if (notifTimestamp > lastNotificationTimestamp) {
                        latestNotification = notificationData;
                        lastNotificationTimestamp = notifTimestamp;
                    }
                });
                allNotifications = currentNotifications.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0)); // Sort by date
                
                unreadNotificationsCount = newUnreadCount; // Update global unread count
                updateNotificationBadge();

                if (latestNotification && !latestNotification.read) { // Only show toast for new unread notifications
                    showToastNotification(latestNotification.title || 'إشعار جديد', latestNotification.content);
                }
                console.log("Notifications updated in real-time.");
            }, (error) => {
                console.error("Error fetching notifications:", error);
            });
        }

        // --- Product Display & Filtering ---
        /**
         * Populates the product type filter dropdown.
         * @param {string[]} types - Array of unique product types.
         */
        function populateProductTypeFilterStore(types) {
            productTypeFilterStore.innerHTML = '<option value="">جميع الأنواع</option>';
            types.sort().forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                productTypeFilterStore.appendChild(option);
            });
            if (productTypeFilterStore.dataset.currentFilter) {
                productTypeFilterStore.value = productTypeFilterStore.dataset.currentFilter;
            }
        }

        /**
         * Applies the selected filter (all, offers, or specific type) and displays products.
         */
        function applyProductFilter() {
            let productsToDisplay = allProducts;
            const searchTerm = productSearchInput.value.toLowerCase();

            if (currentFilter === 'offers') {
                productsToDisplay = allProducts.filter(product => product.isOffer === true);
            } else if (currentFilter !== 'all' && currentFilter !== '') {
                productsToDisplay = allProducts.filter(product => product.type === currentFilter);
            }
            
            // Apply search term filter
            if (searchTerm) {
                productsToDisplay = productsToDisplay.filter(product => 
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.description.toLowerCase().includes(searchTerm) ||
                    (product.type && product.type.toLowerCase().includes(searchTerm))
                );
            }

            displayProducts(productsToDisplay);

            if (productsToDisplay.length === 0) {
                productsDisplay.innerHTML = `<p class="text-center text-gray-500 w-full">لا توجد منتجات ${currentFilter === 'offers' ? 'ضمن العروض' : currentFilter === 'all' ? 'لعرضها حالياً' : `من نوع "${currentFilter}"`} حالياً.</p>`;
            }
        }

        /**
         * Displays products on the store front-end.
         * @param {Array<Object>} products - Array of product objects.
         */
        function displayProducts(products) {
            productsDisplay.innerHTML = ''; 
            if (products.length === 0) {
                return;
            }
            
            // Display products in two columns
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.classList.add('product-card');
                productCard.innerHTML = `
                    <img src="${product.imageUrl || `https://placehold.co/300x300/e0e0e0/000?text=${product.name}`}" alt="${product.name}" onerror="this.onerror=null;this.src='https://placehold.co/300x300/e0e0e0/000?text=صورة+غير+متوفرة';">
                    <div class="product-card-info">
                        <h3>${product.name}</h3>
                        <p class="price">${parseFloat(product.price).toFixed(0)} IQD</p>
                        <span class="availability ${
                            product.availability === 'متوفر' ? 'bg-green-100 text-green-800' :
                            product.availability === 'غير متوفر' ? 'bg-red-100 text-red-800' :
                            'bg-blue-100 text-blue-800'
                        }">
                            ${product.availability}
                        </span>
                        <div class="buttons-container">
                            <button data-id="${product.id}" class="view-details-btn">التفاصيل</button>
                            <button data-id="${product.id}" class="add-to-cart-btn-card"><i class="fas fa-cart-plus"></i></button>
                        </div>
                    </div>
                `;
                productsDisplay.appendChild(productCard);
            });

            document.querySelectorAll('.view-details-btn').forEach(button => {
                button.onclick = (e) => showProductDetails(e.target.dataset.id);
            });
            document.querySelectorAll('.add-to-cart-btn-card').forEach(button => {
                button.onclick = (e) => {
                    const productId = e.target.dataset.id || e.target.closest('button').dataset.id;
                    const productToAdd = allProducts.find(p => p.id === productId);
                    if (productToAdd) {
                        addProductToCart(productToAdd);
                    }
                };
            });
        }

        /**
         * Shows the product details page with the given product's information.
         * @param {string} productId - The ID of the product to display.
         */
        function showProductDetails(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (product) {
                detailsPageTitle.textContent = product.name; 
                detailsImage.src = product.imageUrl || `https://placehold.co/300x300/e0e0e0/000?text=${product.name}`;
                detailsImage.onerror = function() { this.onerror=null; this.src='https://placehold.co/300x300/e0e0e0/000?text=صورة+غير+متوفرة'; }; 
                detailsName.textContent = product.name;
                detailsType.textContent = `النوع: ${product.type || 'غير محدد'}`;
                detailsDescription.textContent = product.description;
                detailsPrice.textContent = `${parseFloat(product.price).toFixed(0)} IQD`;
                detailsAvailability.textContent = `التوفر: ${product.availability}`;
                detailsAvailability.className = `availability ${
                    product.availability === 'متوفر' ? 'bg-green-100 text-green-800' :
                    product.availability === 'غير متوفر' ? 'bg-red-100 text-red-800' :
                    'bg-blue-100 text-blue-800'
                }`;
                addToCartBtn.onclick = () => addProductToCart(product); 
                navigateTo(productDetailsPage, product.name); 
            }
        }

        // --- Cart Logic ---
        /**
         * Adds a product to the cart.
         * @param {Object} product - The product object to add.
         */
        function addProductToCart(product) {
            const existingItem = cartItems.find(item => item.id === product.id);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cartItems.push({ ...product, quantity: 1 });
            }
            updateCartDisplay();
            alertMessage('تمت إضافة المنتج إلى السلة!', 'success');
        }

        /**
         * Removes a product from the cart.
         * @param {string} productId - The ID of the product to remove.
         */
        function removeProductFromCart(productId) {
            cartItems = cartItems.filter(item => item.id !== productId);
            updateCartDisplay();
            alertMessage('تم حذف المنتج من السلة.', 'info');
        }

        /**
         * Updates quantity of a product in the cart.
         * @param {string} productId - The ID of the product.
         * @param {number} delta - Change in quantity (+1 or -1).
         */
        function updateCartItemQuantity(productId, delta) {
            const item = cartItems.find(i => i.id === productId);
            if (item) {
                item.quantity += delta;
                if (item.quantity <= 0) {
                    removeProductFromCart(productId);
                } else {
                    updateCartDisplay();
                }
            }
        }

        /**
         * Calculates delivery cost based on product types and governorate.
         * @param {string} governorate - The selected governorate.
         * @returns {number} The delivery cost.
         */
        function calculateDeliveryCost(governorate) {
            let hasBooks = false;
            let hasOtherProducts = false;

            cartItems.forEach(item => {
                if (item.type && (item.type.toLowerCase().includes('كتاب') || item.type.toLowerCase().includes('رواية') || item.type.toLowerCase().includes('أدبي'))) {
                    hasBooks = true;
                } else {
                    hasOtherProducts = true;
                }
            });

            // Books delivery logic
            if (hasBooks && governorate === 'البصرة') return 3000;
            if (hasBooks && governorate !== 'البصرة' && governorate !== '') return 5000;

            // Other products delivery logic
            if (hasOtherProducts && governorate === 'الناصرية') return 3000;
            if (hasOtherProducts && governorate !== 'الناصرية' && governorate !== '') return 5000;
            
            return 0; 
        }

        /**
         * Updates the cart display and total.
         */
        function updateCartDisplay() {
            cartItemsContainer.innerHTML = '';
            let productsSubtotal = 0;
            let deliveryCost = 0;
            const selectedGovernorate = governorateSelect.value; 

            if (cartItems.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-center text-gray-500">سلتك فارغة حالياً.</p>';
            } else {
                cartItems.forEach(item => {
                    const itemPrice = parseFloat(item.price.replace(/[^0-9.-]+/g,"")); 
                    productsSubtotal += itemPrice * item.quantity;

                    const cartItemDiv = document.createElement('div');
                    cartItemDiv.classList.add('cart-item');
                    cartItemDiv.innerHTML = `
                        <img src="${item.imageUrl || `https://placehold.co/60x60/e0e0e0/000?text=${item.name}`}" alt="${item.name}" onerror="this.onerror=null;this.src='https://placehold.co/60x60/e0e0e0/000?text=صورة';">
                        <div class="cart-item-info">
                            <h4>${item.name}</h4>
                            <p>${item.price} IQD x ${item.quantity}</p>
                        </div>
                        <div class="quantity-controls">
                            <button data-id="${item.id}" data-delta="-1">-</button>
                            <span>${item.quantity}</span>
                            <button data-id="${item.id}" data-delta="1">+</button>
                        </div>
                        <button data-id="${item.id}" class="remove-btn"><i class="fas fa-trash"></i></button>
                    `;
                    cartItemsContainer.appendChild(cartItemDiv);
                });
            }

            deliveryCost = calculateDeliveryCost(selectedGovernorate);
            const finalTotal = productsSubtotal + deliveryCost;

            productsSubtotalDisplay.textContent = `${productsSubtotal.toFixed(0)} IQD`; 
            deliveryCostDisplay.textContent = `${deliveryCost.toFixed(0)} IQD`;
            finalTotalDisplay.textContent = `${finalTotal.toFixed(0)} IQD`;
            totalPriceFormInput.value = finalTotal.toFixed(0); 

            document.querySelectorAll('.remove-btn').forEach(button => {
                button.onclick = (e) => removeProductFromCart(e.target.dataset.id || e.target.closest('button').dataset.id);
            });
            document.querySelectorAll('.quantity-controls button').forEach(button => {
                button.onclick = (e) => {
                    const productId = e.target.dataset.id || e.target.closest('button').dataset.id;
                    const delta = parseInt(e.target.dataset.delta);
                    updateCartItemQuantity(productId, delta);
                };
            });
        }

        // --- Layla Chat Logic ---
        /**
         * Layla's AI logic to respond to user queries in the chat.
         * This function is now enhanced to log interactions to Firestore.
         * @param {string} queryText - The user's query.
         */
        async function getLaylaResponse(queryText) {
            const lowerCaseQuery = queryText.toLowerCase();
            let response = 'عذراً، لم أفهم سؤالك. هل يمكنك إعادة الصياغة؟';
            let intentIdentified = 'عدم_فهم';
            let isUnanswered = true;

            try {
                // 1. Try to match an Intent
                for (const intent of allIntents) {
                    const trainingPhrases = intent.trainingPhrases.map(p => p.toLowerCase());
                    if (trainingPhrases.some(phrase => lowerCaseQuery.includes(phrase))) {
                        response = intent.output;
                        intentIdentified = intent.name;
                        isUnanswered = false;
                        break;
                    }
                }

                // 2. If no intent matched, try to match a Product
                if (isUnanswered) { // Only try product matching if no intent was found
                    for (const product of allProducts) {
                        const productNameLower = product.name.toLowerCase();
                        const productDescriptionLower = product.description.toLowerCase();
                        const productTypeLower = product.type ? product.type.toLowerCase() : '';

                        if (lowerCaseQuery.includes(productNameLower) ||
                            lowerCaseQuery.includes(productDescriptionLower) ||
                            lowerCaseQuery.includes(productTypeLower)) {
                            response = `بالتأكيد! لدينا "${product.name}" (النوع: ${product.type || 'غير محدد'}). وصف المنتج: "${product.description}". السعر: ${parseFloat(product.price).toFixed(0)} IQD. حالة التوفر: ${product.availability}.`;
                            intentIdentified = 'معلومات_منتج'; // A generic intent for product info
                            isUnanswered = false;
                            break;
                        }
                    }
                }

                // Log the interaction to Firestore
                // Corrected Firestore path to match dashboard's expectation
                await addDoc(collection(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${ADMIN_USER_ID}/chat_logs`), {
                    userId: clientUserId, // Use the client's actual UID
                    timestamp: Timestamp.now(),
                    userQuery: queryText,
                    laylaResponse: response,
                    intentIdentified: intentIdentified,
                    unanswered: isUnanswered, // Changed to 'unanswered' to match dashboard
                    reviewed: false // New field to track if reviewed by admin
                });
                console.log("Layla interaction logged to Firestore from store.");

                return response;

            } catch (e) {
                console.error("Error in Layla AI logic or Firestore logging from store:", e);
                // Attempt to log the error interaction itself
                try {
                    // Corrected Firestore path for error logging as well
                    await addDoc(collection(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${ADMIN_USER_ID}/chat_logs`), {
                        userId: clientUserId,
                        timestamp: Timestamp.now(),
                        userQuery: queryText,
                        laylaResponse: `حدث خطأ: ${e.message}`,
                        intentIdentified: 'خطأ_نظام',
                        unanswered: true, // Mark as unanswered due to error
                        reviewed: false
                    });
                } catch (logError) {
                    console.error("Failed to log error interaction from store:", logError);
                }
                return `حدث خطأ أثناء محاولة ليلى الرد: ${e.message}`;
            }
        }

        /**
         * Adds a message to the chat window.
         * @param {string} sender - The sender of the message (e.g., "أنت", "ليلى").
         * @param {string} text - The message text.
         * @param {string} type - CSS class for styling ('user-message' or 'layla-message').
         */
        function addChatMessage(sender, text, type) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', type);
            messageDiv.textContent = `${sender}: ${text}`;
            chatMessagesContainer.appendChild(messageDiv);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        // --- Notification Logic ---
        function updateNotificationBadge() {
            if (unreadNotificationsCount > 0) {
                notificationBadge.textContent = unreadNotificationsCount;
                notificationBadge.classList.remove('hidden');
            } else {
                notificationBadge.classList.add('hidden');
            }
        }

        function showToastNotification(title, content) {
            toastTitle.textContent = title;
            toastContent.textContent = content;
            toastNotification.classList.add('show');
            setTimeout(() => {
                toastNotification.classList.remove('show');
            }, 5000); // Hide after 5 seconds
        }

        function showNotificationsModal() {
            notificationsList.innerHTML = '';
            if (allNotifications.length === 0) {
                notificationsList.innerHTML = '<p class="no-notifications">لا توجد إشعارات حالياً.</p>';
            } else {
                allNotifications.forEach(notif => {
                    const notifDiv = document.createElement('div');
                    notifDiv.classList.add('notification-item');
                    if (!notif.read) {
                        notifDiv.classList.add('font-bold'); 
                    }
                    const date = notif.createdAt?.toDate ? notif.createdAt.toDate() : new Date(notif.createdAt);
                    notifDiv.innerHTML = `
                        <h4>${notif.title || 'إشعار جديد'}</h4>
                        <p>${notif.content}</p>
                        <p class="timestamp">${date.toLocaleString('ar-EG', { dateStyle: 'short', timeStyle: 'short' })}</p>
                    `;
                    notifDiv.onclick = async () => {
                        if (!notif.read) {
                            // Mark as read in Firestore
                            const notifRef = doc(db, `artifacts/${APP_ID_FOR_FIRESTORE_PATH}/users/${ADMIN_USER_ID}/store_notifications`, notif.id);
                            await updateDoc(notifRef, { read: true });
                            // The onSnapshot listener will update the local allNotifications and badge
                        }
                    };
                    notificationsList.appendChild(notifDiv);
                });
            }
            showModal(notificationModal);
        }

        // --- Checkout Form Logic ---
        const IraqiGovernorates = [
            "نينوى", "بغداد", "البصرة", "الأنبار", "بابل", "صلاح الدين", "ديالى", "كربلاء",
            "النجف", "واسط", "ذي قار", "المثنى", "القادسية", "ميسان", "كركوك", "أربيل",
            "السليمانية", "دهوك", "الناصرية"
        ].sort(); 

        function populateGovernorates() {
            governorateSelect.innerHTML = '<option value="">اختر محافظتك</option>';
            IraqiGovernorates.forEach(gov => {
                const option = document.createElement('option');
                option.value = gov;
                option.textContent = gov;
                governorateSelect.appendChild(option);
            });
        }

        function loadSavedAddress() {
            const savedAddress = localStorage.getItem('savedAddress');
            if (savedAddress) {
                const address = JSON.parse(savedAddress);
                governorateSelect.value = address.governorate || '';
                areaInput.value = address.area || '';
                landmarkInput.value = address.landmark || '';
                phoneNumberInput.value = address.phoneNumber || '';
                
                // Prompt user to use saved address
                // Replaced confirm() with a custom modal for better UX
                showCustomConfirmModal("هل تريد استخدام العنوان المحفوظ؟", "اضغط موافق للاستخدام أو إلغاء لإدخال عنوان جديد.", 
                    () => { // On Confirm
                        updateCartDisplay(); 
                    }, 
                    () => { // On Cancel
                        clearAddressForm();
                    }
                );
            }
        }

        function clearAddressForm() {
            governorateSelect.value = '';
            areaInput.value = '';
            landmarkInput.value = '';
            phoneNumberInput.value = '';
            additionalNotesInput.value = '';
            saveAddressCheckbox.checked = false;
            saveAddressTip.classList.add('hidden');
            updateCartDisplay(); // Recalculate delivery cost to 0
        }

        function saveAddress() {
            const address = {
                governorate: governorateSelect.value,
                area: areaInput.value,
                landmark: landmarkInput.value,
                phoneNumber: phoneNumberInput.value
            };
            localStorage.setItem('savedAddress', JSON.stringify(address));
        }

        // Custom Confirm Modal (replaces window.confirm)
        function showCustomConfirmModal(title, message, onConfirm, onCancel) {
            const modal = document.createElement('div');
            modal.classList.add('app-modal', 'open');
            modal.innerHTML = `
                <div class="app-modal-content">
                    <h3 class="text-xl font-bold text-center mb-4">${title}</h3>
                    <p class="text-gray-700 text-center mb-6">${message}</p>
                    <div class="flex justify-around gap-4">
                        <button id="confirmBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg flex-1">موافق</button>
                        <button id="cancelBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg flex-1">إلغاء</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('#confirmBtn').onclick = () => {
                onConfirm();
                modal.remove();
            };
            modal.querySelector('#cancelBtn').onclick = () => {
                onCancel();
                modal.remove();
            };
        }


        // --- Event Listeners ---
        // Bottom Navigation
        navItems.forEach(item => {
            item.onclick = () => {
                const pageId = item.dataset.page;
                let pageElement;
                let pageTitle;

                if (pageId === 'products-page') {
                    pageElement = productsPage;
                    pageTitle = 'متجر TERAKS'; 
                    currentFilter = 'all'; 
                    applyProductFilter();
                } else if (pageId === 'chat-page') {
                    pageElement = chatPage;
                    pageTitle = 'تحدث مع ليلى';
                } else if (pageId === 'cart-page') {
                    pageElement = cartPage;
                    pageTitle = 'السلة';
                    updateCartDisplay(); 
                }
                navigateTo(pageElement, pageTitle);
            };
        });

        // Product Search
        productSearchInput.oninput = applyProductFilter;

        // Product Type Filter
        productTypeFilterStore.onchange = (e) => {
            currentFilter = e.target.value === '' ? 'all' : e.target.value;
            applyProductFilter();
        };

        // Show Offers Button
        showOffersBtn.onclick = () => {
            currentFilter = 'offers';
            productTypeFilterStore.value = ''; 
            productSearchInput.value = ''; 
            applyProductFilter();
        };

        // Back button on Product Details Page
        backToProductsBtn.onclick = () => {
            navigateTo(productsPage, 'متجر TERAKS', true); 
        };

        // Chat Send Button
        sendChatBtn.onclick = async () => {
            const query = chatInput.value.trim();
            if (query) {
                addChatMessage("أنت", query, 'user-message');
                chatInput.value = ''; 
                const laylaResponse = await getLaylaResponse(query); // Call Layla's AI logic
                addChatMessage("ليلى", laylaResponse, 'layla-message');
            }
        };

        // Chat Input Enter Key
        chatInput.onkeypress = (e) => {
            if (e.key === 'Enter') {
                sendChatBtn.click();
            }
        };

        // Checkout Button
        checkoutBtn.onclick = () => {
            if (cartItems.length === 0) {
                alertMessage('سلتك فارغة. لا يمكنك إتمام عملية الشراء.', 'info');
                return;
            }
            populateGovernorates(); 
            loadSavedAddress(); 
            updateCartDisplay(); 
            showModal(checkoutModal);
        };

        // Checkout Modal Close Button
        closeCheckoutModalBtn.onclick = () => hideModal(checkoutModal);

        // Checkout Form Submission
        checkoutForm.onsubmit = async (e) => {
            e.preventDefault(); 

            const formData = new FormData(checkoutForm);
            const orderDetails = {};
            formData.forEach((value, key) => {
                orderDetails[key] = value;
            });

            // Add cart items to order details
            orderDetails['المنتجات المطلوبة'] = cartItems.map(item => 
                `${item.name} (${item.type || 'غير محدد'}) - ${parseFloat(item.price).toFixed(0)} IQD x ${item.quantity}`
            ).join('\n');
            orderDetails['إجمالي المنتجات'] = productsSubtotalDisplay.textContent;
            orderDetails['تكلفة التوصيل'] = deliveryCostDisplay.textContent;
            orderDetails['الإجمالي الكلي'] = finalTotalDisplay.textContent;

            // Prepare for Formspree
            const formspreeData = new FormData();
            for (const key in orderDetails) {
                formspreeData.append(key, orderDetails[key]);
            }

            try {
                const response = await fetch(checkoutForm.action, {
                    method: checkoutForm.method,
                    body: formspreeData,
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (response.ok) {
                    alertMessage('!تم إرسال طلبك بنجاح', 'success');
                    hideModal(checkoutModal);
                    cartItems = []; 
                    updateCartDisplay();
                    if (saveAddressCheckbox.checked) {
                        saveAddress();
                    } else {
                        localStorage.removeItem('savedAddress'); 
                    }
                } else {
                    const data = await response.json();
                    alertMessage(`خطأ في إرسال الطلب: ${data.errors ? data.errors.map(err => err.message).join(', ') : 'خطأ غير معروف'}`, 'error');
                }
            } catch (error) {
                alertMessage('حدث خطأ في الاتصال. يرجى المحاولة مرة أخرى.', 'error');
                console.error('Form submission error:', error);
            }
        };

        // Governorate selection changes delivery cost
        governorateSelect.onchange = updateCartDisplay;

        // Save Address checkbox tip
        saveAddressCheckbox.onchange = () => {
            if (saveAddressCheckbox.checked) {
                saveAddressTip.classList.remove('hidden');
            } else {
                saveAddressTip.classList.add('hidden');
            }
        };

        // Notification Icon
        notificationIcon.onclick = showNotificationsModal;
        closeNotificationModalBtn.onclick = () => hideModal(notificationModal);

        // Email Icon
        emailIcon.onclick = () => {
            window.location.href = 'mailto:f300f30m@gmail.com?subject=استفسار من متجر TERAKS&body=مرحباً، أود الاستفسار عن...';
        };

        // Privacy Policy Icon
        privacyPolicyIcon.onclick = () => showModal(privacyPolicyModal);
        closePrivacyPolicyModalBtn.onclick = () => hideModal(privacyPolicyModal);


        // Initialize Firebase when the window loads
        window.onload = () => {
            initializeFirebase();
            // Set initial page to products
            navigateTo(productsPage, 'متجر TERAKS'); 
            
            // Remove sample products now that the app is fully functional
            // allProducts will be populated directly from Firestore
        };
    </script>
</body>
</html>
